<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Factura - Sistema LAMDA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .badge.borrador {
            background: #fff3cd;
            color: #856404;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .items-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .items-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .items-table input,
        .items-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .totals {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 16px;
        }

        .totals-row.total {
            border-top: 2px solid #667eea;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 30px;
            background: #f8f9fa;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úèÔ∏è Editar Factura</h1>
            <p>Sistema LAMDA - M√≥dulo de Facturaci√≥n</p>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Cargando factura...</p>
        </div>

        <div id="content" class="content" style="display: none;">
            <span class="badge borrador" id="estado-badge">BORRADOR</span>

            <form id="form-factura">
                <!-- Datos del Comprobante -->
                <div class="section">
                    <h2 class="section-title">üìÑ Datos del Comprobante</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tipo de Comprobante *</label>
                            <select id="tipo_cbte" required>
                                <option value="6">Factura B</option>
                                <option value="11">Factura C</option>
                                <option value="1">Factura A</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Punto de Venta *</label>
                            <input type="number" id="pto_vta" value="32" required>
                        </div>
                        <div class="form-group">
                            <label>Concepto *</label>
                            <select id="concepto" required>
                                <option value="1">Productos</option>
                                <option value="2">Servicios</option>
                                <option value="3">Productos y Servicios</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Emisi√≥n *</label>
                            <input type="date" id="fecha_emision" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="requiere_afip" checked>
                            <label for="requiere_afip">Requiere AFIP (Factura Electr√≥nica)</label>
                        </div>
                        <p class="help-text">Si no est√° marcado, ser√° una factura interna sin CAE</p>
                    </div>
                </div>

                <!-- Datos del Receptor -->
                <div class="section">
                    <h2 class="section-title">üë§ Datos del Receptor</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Raz√≥n Social / Nombre *</label>
                            <input type="text" id="razon_social" required placeholder="Nombre del cliente o Consumidor Final">
                            <p class="help-text">Nombre completo del receptor de la factura</p>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Documento *</label>
                            <select id="doc_tipo" required onchange="actualizarCondicionIVA()">
                                <option value="99">99 - Consumidor Final</option>
                                <option value="80">80 - CUIT</option>
                                <option value="96">96 - DNI</option>
                                <option value="86">86 - CUIL</option>
                            </select>
                            <p class="help-text">Para Factura B, usar Consumidor Final si aplica</p>
                        </div>
                        <div class="form-group">
                            <label>N√∫mero de Documento *</label>
                            <input type="text" id="doc_nro" value="0" required>
                            <p class="help-text">0 para Consumidor Final. Ingrese CUIT/DNI sin puntos/guiones</p>
                        </div>
                        <div class="form-group">
                            <label>Condici√≥n IVA * (CR√çTICO)</label>
                            <select id="condicion_iva_id" required>
                                <option value="5">5 - Consumidor Final</option>
                                <option value="1">1 - Responsable Inscripto</option>
                                <option value="6">6 - Responsable Monotributo</option>
                                <option value="4">4 - Exento</option>
                                <option value="2">2 - Responsable no Inscripto</option>
                                <option value="3">3 - No Responsable</option>
                            </select>
                            <p class="help-text">‚ö†Ô∏è Obligatorio para AFIP. Se ajusta autom√°ticamente seg√∫n tipo de documento</p>
                        </div>
                    </div>
                </div>

                <!-- Items -->
                <div class="section">
                    <h2 class="section-title">üì¶ Items de la Factura</h2>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th style="width: 100px;">Cantidad</th>
                                <th style="width: 120px;">Precio Unit.</th>
                                <th style="width: 120px;">IVA</th>
                                <th style="width: 120px;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody">
                            <!-- Se llena din√°micamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Totales -->
                <div class="totals">
                    <div class="totals-row">
                        <span>Subtotal (Neto):</span>
                        <span id="total-neto">$ 0,00</span>
                    </div>
                    <div class="totals-row">
                        <span>IVA:</span>
                        <span id="total-iva">$ 0,00</span>
                    </div>
                    <div class="totals-row total">
                        <span>TOTAL:</span>
                        <span id="total-general">$ 0,00</span>
                    </div>
                </div>
            </form>
        </div>

        <div class="actions" id="actions" style="display: none;">
            <button class="btn btn-secondary" onclick="window.close()">Cancelar</button>
            <button class="btn btn-primary" id="btn-guardar" onclick="guardarFactura()">üíæ Guardar Cambios</button>
            <button class="btn btn-success" id="btn-obtener-cae" onclick="obtenerCAE()" style="display: none;">
                üìÑ Guardar y Obtener CAE
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3004/facturacion';
        let facturaId = null;
        let facturaData = null;

        // Obtener ID de la URL
        const urlParams = new URLSearchParams(window.location.search);
        facturaId = urlParams.get('id');

        if (!facturaId) {
            alert('No se especific√≥ el ID de la factura');
            window.close();
        } else {
            cargarFactura();
        }

        async function cargarFactura() {
            try {
                console.log('üîç Cargando factura ID:', facturaId);

                const response = await fetch(`${API_URL}/facturas/${facturaId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    facturaData = result.data;

                    // Si la factura tiene cliente_id pero no tiene datos del cliente, intentar obtenerlos
                    // Usar try-catch para que no bloquee la carga si falla
                    if (facturaData.cliente_id && (!facturaData.razon_social || facturaData.doc_tipo === 99)) {
                        try {
                            console.log('üîÑ Intentando cargar datos del cliente...');
                            await Promise.race([
                                cargarDatosCliente(facturaData.cliente_id),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
                            ]);
                        } catch (clienteError) {
                            console.warn('‚ö†Ô∏è No se pudieron cargar datos del cliente (no cr√≠tico):', clienteError.message);
                            // Continuar de todos modos con los datos que tenemos
                        }
                    }

                    // Siempre renderizar el formulario, incluso si fall√≥ la carga del cliente
                    renderizarFormulario(facturaData);
                } else {
                    throw new Error(result.message || 'Error al cargar factura');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error al cargar la factura: ' + error.message);
                window.close();
            }
        }

        async function cargarDatosCliente(clienteId) {
            try {
                console.log('üîç Cargando datos del cliente:', clienteId);

                // Intentar obtener datos del cliente desde la API de presupuestos
                const response = await fetch(`http://localhost:3003/api/presupuestos/clientes/${clienteId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    const cliente = result.data;
                    console.log('‚úÖ Datos del cliente obtenidos:', cliente);

                    // Actualizar los datos de la factura con la informaci√≥n del cliente
                    facturaData.razon_social = cliente.nombre || '';
                    if (cliente.apellido) {
                        facturaData.razon_social += ' ' + cliente.apellido;
                    }

                    // Determinar tipo de documento y n√∫mero
                    if (cliente.cuit && cliente.cuit.trim()) {
                        const cuitLimpio = cliente.cuit.replace(/[-\s]/g, '');
                        if (cuitLimpio.length === 11 && /^\d+$/.test(cuitLimpio)) {
                            facturaData.doc_tipo = 80; // CUIT
                            facturaData.doc_nro = cuitLimpio;
                        }
                    } else if (cliente.cuil && cliente.cuil.trim()) {
                        const cuilLimpio = cliente.cuil.replace(/[-\s]/g, '');
                        if (cuilLimpio.length === 11 && /^\d+$/.test(cuilLimpio)) {
                            facturaData.doc_tipo = 86; // CUIL
                            facturaData.doc_nro = cuilLimpio;
                        }
                    } else if (cliente.dni && cliente.dni.trim()) {
                        const dniLimpio = cliente.dni.replace(/[-\s]/g, '');
                        if (dniLimpio.length >= 7 && dniLimpio.length <= 8 && /^\d+$/.test(dniLimpio)) {
                            facturaData.doc_tipo = 96; // DNI
                            facturaData.doc_nro = dniLimpio;
                        }
                    }

                    // Mapear condici√≥n IVA
                    if (cliente.condicion_iva) {
                        const condicionTexto = String(cliente.condicion_iva).trim();
                        const mapeoCondicion = {
                            'Responsable Inscripto': 1,
                            'Responsable no Inscripto': 2,
                            'No Responsable': 3,
                            'Exento': 4,
                            'Consumidor Final': 5,
                            'Responsable Monotributo': 6,
                            'Monotributo': 6,
                            'IVA Liberado': 10
                        };
                        facturaData.condicion_iva_id = mapeoCondicion[condicionTexto] || 5;
                    }

                    // Actualizar tipo de comprobante seg√∫n condici√≥n IVA
                    actualizarTipoComprobante();

                } else {
                    console.warn('‚ö†Ô∏è No se pudieron obtener datos del cliente');
                }
            } catch (error) {
                console.error('‚ùå Error al cargar datos del cliente:', error);
            }
        }

        function actualizarTipoComprobante() {
            const condicionIVA = facturaData.condicion_iva_id || 5;

            // L√≥gica de tipo de comprobante seg√∫n condici√≥n IVA
            if (condicionIVA === 1) {
                // Responsable Inscripto -> Factura A
                facturaData.tipo_cbte = 1;
            } else {
                // Otros -> Factura B
                facturaData.tipo_cbte = 6;
            }

            console.log(`üìÑ Tipo de comprobante actualizado: ${facturaData.tipo_cbte} (Condici√≥n IVA: ${condicionIVA})`);
        }

        function renderizarFormulario(factura) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            document.getElementById('actions').style.display = 'flex';

            // Llenar campos
            document.getElementById('tipo_cbte').value = factura.tipo_cbte || 6;
            document.getElementById('pto_vta').value = factura.pto_vta || 32;
            document.getElementById('concepto').value = factura.concepto || 1;
            document.getElementById('fecha_emision').value = factura.fecha_emision || new Date().toISOString().split('T')[0];
            document.getElementById('requiere_afip').checked = factura.requiere_afip !== false;
            document.getElementById('razon_social').value = factura.razon_social || '';
            document.getElementById('doc_tipo').value = factura.doc_tipo || 99;
            document.getElementById('doc_nro').value = factura.doc_nro || '0';
            document.getElementById('condicion_iva_id').value = factura.condicion_iva_id || 5;

            // Renderizar items
            renderizarItems(factura.items || []);

            // Calcular totales
            calcularTotales();

            // Mostrar bot√≥n de CAE si es BORRADOR y requiere AFIP
            if (factura.estado === 'BORRADOR' && factura.requiere_afip) {
                document.getElementById('btn-obtener-cae').style.display = 'inline-block';
            }
        }

        function renderizarItems(items) {
            const tbody = document.getElementById('items-tbody');
            tbody.innerHTML = items.map((item, index) => {
                // Normalizar c√≥digo antiguo (1‚Üí5, 2‚Üí4)
                const codigoNormalizado = (item.alic_iva_id === 1 ? 5 : item.alic_iva_id === 2 ? 4 : item.alic_iva_id);
                
                return `
                <tr>
                    <td>
                        <input type="text" value="${item.descripcion || ''}" 
                               onchange="actualizarItem(${index}, 'descripcion', this.value)">
                    </td>
                    <td>
                        <input type="number" step="0.001" value="${item.qty || 0}" 
                               onchange="actualizarItem(${index}, 'qty', this.value); calcularTotales();">
                    </td>
                    <td>
                        <input type="number" step="0.01" value="${item.p_unit || 0}" 
                               onchange="actualizarItem(${index}, 'p_unit', this.value); calcularTotales();">
                    </td>
                    <td>
                        <select onchange="actualizarItem(${index}, 'alic_iva_id', this.value); calcularTotales();">
                            <option value="5" ${codigoNormalizado == 5 ? 'selected' : ''}>21%</option>
                            <option value="4" ${codigoNormalizado == 4 ? 'selected' : ''}>10.5%</option>
                            <option value="6" ${codigoNormalizado == 6 ? 'selected' : ''}>27%</option>
                            <option value="3" ${codigoNormalizado == 3 ? 'selected' : ''}>0%</option>
                        </select>
                    </td>
                    <td>
                        <strong>${formatMoney((item.qty || 0) * (item.p_unit || 0))}</strong>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function actualizarItem(index, campo, valor) {
            if (!facturaData.items[index]) return;
            facturaData.items[index][campo] = campo === 'descripcion' ? valor : parseFloat(valor) || 0;
        }

        function actualizarCondicionIVA() {
            const docTipo = parseInt(document.getElementById('doc_tipo').value);
            const condicionIVASelect = document.getElementById('condicion_iva_id');

            // L√≥gica de mapeo autom√°tico seg√∫n tipo de documento
            if (docTipo === 99) {
                // Consumidor Final
                condicionIVASelect.value = '5';
            } else if (docTipo === 80) {
                // CUIT - Asumir Responsable Inscripto por defecto
                condicionIVASelect.value = '1';
            } else if (docTipo === 96 || docTipo === 86) {
                // DNI/CUIL - Asumir Consumidor Final
                condicionIVASelect.value = '5';
            }

            console.log('Condici√≥n IVA ajustada autom√°ticamente:', condicionIVASelect.value);
        }

        function calcularTotales() {
            let totalNeto = 0;
            let totalIVA = 0;

            facturaData.items.forEach(item => {
                const subtotal = (item.qty || 0) * (item.p_unit || 0);
                totalNeto += subtotal;

                // Calcular IVA seg√∫n al√≠cuota
                const alicuotas = { 3: 0, 4: 10.5, 5: 21, 6: 27 };
                const porcentaje = alicuotas[item.alic_iva_id] || 21;
                totalIVA += subtotal * (porcentaje / 100);
            });

            const totalGeneral = totalNeto + totalIVA;

            document.getElementById('total-neto').textContent = formatMoney(totalNeto);
            document.getElementById('total-iva').textContent = formatMoney(totalIVA);
            document.getElementById('total-general').textContent = formatMoney(totalGeneral);
        }

        async function guardarFactura() {
            const btn = document.getElementById('btn-guardar');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Guardando...';

            try {
                const datosActualizados = {
                    tipo_cbte: parseInt(document.getElementById('tipo_cbte').value),
                    pto_vta: parseInt(document.getElementById('pto_vta').value),
                    concepto: parseInt(document.getElementById('concepto').value),
                    fecha_emision: document.getElementById('fecha_emision').value,
                    requiere_afip: document.getElementById('requiere_afip').checked,
                    razon_social: document.getElementById('razon_social').value.trim(),
                    doc_tipo: parseInt(document.getElementById('doc_tipo').value),
                    doc_nro: document.getElementById('doc_nro').value,
                    condicion_iva_id: parseInt(document.getElementById('condicion_iva_id').value),
                    items: facturaData.items
                };

                console.log('üíæ Guardando factura:', datosActualizados);

                const response = await fetch(`${API_URL}/facturas/${facturaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosActualizados)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Factura actualizada correctamente');
                    window.location.href = `ver-factura.html?id=${facturaId}`;
                } else {
                    throw new Error(result.message || 'Error al guardar');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error al guardar: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üíæ Guardar Cambios';
            }
        }

        async function obtenerCAE() {
            if (!confirm('¬øGuardar cambios y obtener CAE de AFIP?')) return;

            // Primero guardar
            await guardarFactura();

            // Luego obtener CAE
            window.location.href = `ver-factura.html?id=${facturaId}&obtener_cae=true`;
        }

        function formatMoney(num) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS'
            }).format(num || 0);
        }
    </script>
</body>
</html>
