let modal = null;
let tablaBody = null;
let btnImprimirTodas = null;
let btnGuardarAjustes = null;
let carroIdGlobal = null;
let usuarioIdGlobal = null;
let ingredientes = [];

export async function abrirModalGuardadoIngredientes(carroId, usuarioId) {
  console.log('\nüöÄ [DIAGN√ìSTICO] INICIANDO FUNCI√ìN abrirModalGuardadoIngredientes');
  console.log('================================================================');
  console.log('‚è∞ Timestamp:', new Date().toISOString());
  console.log('üîç [GUARDADO] Par√°metros recibidos:', { 
    carroId: carroId, 
    tipoCarroId: typeof carroId,
    usuarioId: usuarioId, 
    tipoUsuarioId: typeof usuarioId 
  });
  
  // PASO 1: Validar par√°metros
  console.log('\nüìã PASO 1: Validando par√°metros...');
  if (!carroId || !usuarioId) {
    console.error('‚ùå [GUARDADO] Faltan par√°metros requeridos');
    console.error('‚ùå carroId:', carroId, '| usuarioId:', usuarioId);
    return;
  }
  console.log('‚úÖ Par√°metros v√°lidos');
  
  carroIdGlobal = carroId;
  usuarioIdGlobal = usuarioId;
  console.log('‚úÖ Variables globales asignadas');

  // PASO 2: Verificar si el modal ya existe
  console.log('\nüìã PASO 2: Verificando estado del modal...');
  console.log('üîç Modal actual:', !!modal);
  console.log('üîç Modal en DOM (por ID):', !!document.getElementById('modal-guardado-ingredientes'));
  
  if (!modal) {
    console.log('üìã Modal no existe, inicializando...');
    inicializarModal();
    console.log('‚úÖ Modal inicializado');
  } else {
    console.log('‚úÖ Modal ya existe, reutilizando');
  }

  // PASO 3: Verificar estado del modal despu√©s de inicializaci√≥n
  console.log('\nüìã PASO 3: Verificando modal despu√©s de inicializaci√≥n...');
  console.log('üîç Modal object:', modal);
  console.log('üîç Modal en DOM:', !!document.getElementById('modal-guardado-ingredientes'));
  
  if (modal) {
    const estilosComputados = window.getComputedStyle(modal);
    console.log('üîç Estado inicial del modal:');
    console.log('   - display:', estilosComputados.display);
    console.log('   - visibility:', estilosComputados.visibility);
    console.log('   - opacity:', estilosComputados.opacity);
    console.log('   - z-index:', estilosComputados.zIndex);
    console.log('   - position:', estilosComputados.position);
  }

  // PASO 4: Cargar ingredientes
  console.log('\nüìã PASO 4: Cargando ingredientes...');
  try {
    await cargarIngredientes();
    console.log('‚úÖ Ingredientes cargados correctamente');
  } catch (error) {
    console.error('‚ùå Error al cargar ingredientes:', error);
    return;
  }

  // PASO 5: Mostrar el modal
  console.log('\nüìã PASO 5: Mostrando el modal...');
  console.log('üîç Estado ANTES de mostrar:');
  if (modal) {
    console.log('   - display antes:', window.getComputedStyle(modal).display);
    console.log('   - visibility antes:', window.getComputedStyle(modal).visibility);
    
    modal.style.display = 'block';
    
    console.log('üîç Estado DESPU√âS de mostrar:');
    console.log('   - display despu√©s:', window.getComputedStyle(modal).display);
    console.log('   - visibility despu√©s:', window.getComputedStyle(modal).visibility);
    console.log('   - opacity despu√©s:', window.getComputedStyle(modal).opacity);
    console.log('   - z-index despu√©s:', window.getComputedStyle(modal).zIndex);
    
    // Verificaci√≥n final despu√©s de un breve delay
    setTimeout(() => {
      const estilosFinales = window.getComputedStyle(modal);
      console.log('üîç Estado FINAL del modal (despu√©s de 100ms):');
      console.log('   - display final:', estilosFinales.display);
      console.log('   - visibility final:', estilosFinales.visibility);
      console.log('   - opacity final:', estilosFinales.opacity);
      console.log('   - z-index final:', estilosFinales.zIndex);
      console.log('   - position final:', estilosFinales.position);
      console.log('   - top final:', estilosFinales.top);
      console.log('   - left final:', estilosFinales.left);
      console.log('   - width final:', estilosFinales.width);
      console.log('   - height final:', estilosFinales.height);
    }, 100);
    
    console.log('‚úÖ [GUARDADO] Modal mostrado correctamente');
  } else {
    console.error('‚ùå Modal es null, no se puede mostrar');
  }
  
  console.log('================================================================\n');
}

function inicializarModal() {
  console.log('üîß [GUARDADO] Inicializando modal');
  
  modal = document.createElement('div');
  modal.id = 'modal-guardado-ingredientes';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 90%; width: 1000px;">
      <div class="modal-header">
        <h2>üì¶ Guardado de Ingredientes</h2>
        <span class="close-modal" style="cursor: pointer; font-size: 24px;">&times;</span>
      </div>
      <div class="modal-body">
        <div class="acciones-globales" style="margin-bottom: 20px;">
          <button id="btn-imprimir-todas-etiquetas" class="btn btn-info">üè∑Ô∏è Imprimir todas las etiquetas</button>
        </div>
        <div class="tabla-container" style="max-height: 400px; overflow-y: auto;">
          <table class="tabla-ingredientes-guardado" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f8f9fa;">
                <th style="padding: 10px; border: 1px solid #ddd;">Sector</th>
                <th style="padding: 10px; border: 1px solid #ddd;">Ingrediente</th>
                <th style="padding: 10px; border: 1px solid #ddd;">Cantidad Necesaria (kg)</th>
                <th style="padding: 10px; border: 1px solid #ddd;">Stock Actual (kg)</th>
                <th style="padding: 10px; border: 1px solid #ddd;">Ajuste Manual (kg)</th>
                <th style="padding: 10px; border: 1px solid #ddd;">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-ingredientes-guardado-body"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer" style="margin-top: 20px; text-align: right;">
        <button id="btn-guardar-ajustes" class="btn btn-primary">üíæ Guardar Ajustes</button>
        <button id="btn-cerrar-modal" class="btn btn-secondary">‚ùå Cerrar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  tablaBody = modal.querySelector('#tabla-ingredientes-guardado-body');
  btnImprimirTodas = modal.querySelector('#btn-imprimir-todas-etiquetas');
  btnGuardarAjustes = modal.querySelector('#btn-guardar-ajustes');
  const btnCerrar = modal.querySelector('#btn-cerrar-modal');
  const btnCerrarX = modal.querySelector('.close-modal');

  btnImprimirTodas.addEventListener('click', imprimirTodasEtiquetas);
  btnGuardarAjustes.addEventListener('click', guardarAjustes);
  btnCerrar.addEventListener('click', cerrarModal);
  btnCerrarX.addEventListener('click', cerrarModal);

  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      cerrarModal();
    }
  });
}

function cerrarModal() {
  if (modal) {
    modal.style.display = 'none';
  }
}

async function cargarIngredientes() {
  try {
    console.log('üì° [GUARDADO] Cargando ingredientes consolidados...');
    const response = await fetch(`http://localhost:3002/api/produccion/carro/${carroIdGlobal}/ingredientes-consolidados?usuarioId=${usuarioIdGlobal}`);
    
    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    ingredientes = data;
    
    console.log(`‚úÖ [GUARDADO] Ingredientes cargados: ${data.total_ingredientes}`);
    renderizarTabla();
  } catch (error) {
    console.error('‚ùå [GUARDADO] Error al cargar ingredientes:', error);
    alert('Error al cargar ingredientes: ' + error.message);
  }
}

function renderizarTabla() {
  console.log('üé® [GUARDADO] Renderizando tabla de ingredientes');
  
  if (!ingredientes.ingredientes || ingredientes.ingredientes.length === 0) {
    tablaBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No hay ingredientes para mostrar</td></tr>';
    return;
  }

  tablaBody.innerHTML = '';
  
  ingredientes.ingredientes.forEach((ing, index) => {
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #ddd';

    const sectorNombre = ing.sector_nombre || 'Sin sector';
    const origenBadge = ing.origen === 'receta' ? 'üìã' : ing.origen === 'ingreso_manual' ? '‚úã' : 'üìã‚úã';
    
    tr.innerHTML = `
      <td style="padding: 8px; border: 1px solid #ddd;">${sectorNombre}</td>
      <td style="padding: 8px; border: 1px solid #ddd;">
        ${origenBadge} ${ing.nombre}
        <small style="display: block; color: #666;">${ing.unidad_medida}</small>
      </td>
      <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${ing.cantidad_necesaria.toFixed(3)}</td>
      <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${ing.stock_actual.toFixed(3)}</td>
      <td style="padding: 8px; border: 1px solid #ddd;">
        <div class="ajuste-container" style="display: flex; align-items: center; gap: 8px;">
          <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px;">
            <input type="checkbox" 
                   class="checkbox-ajuste" 
                   data-ingrediente-id="${ing.id}"
                   style="margin-right: 4px;">
            Ajustar
          </label>
          <input type="number" min="0" step="0.001" 
                 placeholder="${ing.stock_actual.toFixed(3)}"
                 data-id="${ing.id}" 
                 class="input-ajuste" 
                 style="width: 100px; padding: 4px; background-color: #f5f5f5;"
                 disabled
                 title="Marque 'Ajustar' para habilitar este campo">
        </div>
      </td>
      <td style="padding: 8px; border: 1px solid #ddd;">
        <button data-id="${ing.id}" 
                data-nombre="${ing.nombre}" 
                class="btn-imprimir-etiqueta btn btn-sm btn-info"
                style="padding: 4px 8px; font-size: 12px;">
          üè∑Ô∏è Etiqueta
        </button>
      </td>
    `;

    tablaBody.appendChild(tr);
  });

  // Agregar event listeners a los botones de imprimir
  tablaBody.querySelectorAll('.btn-imprimir-etiqueta').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      const nombre = btn.getAttribute('data-nombre');
      imprimirEtiqueta(id, nombre);
    });
  });

  // Agregar event listeners a los checkboxes de ajuste
  tablaBody.querySelectorAll('.checkbox-ajuste').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      toggleAjusteIngrediente(e.target);
    });
  });

  console.log(`‚úÖ [GUARDADO] Tabla renderizada con ${ingredientes.ingredientes.length} ingredientes`);
}

async function imprimirEtiqueta(ingredienteId, nombre) {
  try {
    console.log(`üè∑Ô∏è [GUARDADO] Imprimiendo etiqueta: ${nombre} (ID: ${ingredienteId})`);
    
    // Llamar al endpoint de impresi√≥n (reutilizar l√≥gica existente)
    const response = await fetch('http://localhost:3000/api/etiquetas/ingrediente', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        nombre: nombre, 
        codigo: ingredienteId.toString()
      })
    });
    
    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${response.statusText}`);
    }
    
    console.log(`‚úÖ [GUARDADO] Etiqueta enviada a imprimir: ${nombre}`);
    alert(`‚úÖ Etiqueta de "${nombre}" enviada a imprimir correctamente`);
  } catch (error) {
    console.error('‚ùå [GUARDADO] Error al imprimir etiqueta:', error);
    alert('‚ùå Error al imprimir etiqueta: ' + error.message);
  }
}

async function imprimirTodasEtiquetas() {
  if (!ingredientes.ingredientes || ingredientes.ingredientes.length === 0) {
    alert('No hay ingredientes para imprimir');
    return;
  }

  console.log(`üè∑Ô∏è [GUARDADO] Imprimiendo todas las etiquetas (${ingredientes.ingredientes.length})`);
  
  let exitosas = 0;
  let errores = 0;

  for (const ing of ingredientes.ingredientes) {
    try {
      await imprimirEtiqueta(ing.id, ing.nombre);
      exitosas++;
      // Peque√±a pausa entre impresiones para no saturar el servidor
      await new Promise(resolve => setTimeout(resolve, 200));
    } catch (error) {
      console.error(`‚ùå Error imprimiendo ${ing.nombre}:`, error);
      errores++;
    }
  }

  alert(`üè∑Ô∏è Impresi√≥n completada:\n‚úÖ Exitosas: ${exitosas}\n‚ùå Errores: ${errores}`);
}

// Funci√≥n para habilitar/deshabilitar el input de ajuste seg√∫n el checkbox
function toggleAjusteIngrediente(checkbox) {
  const ingredienteId = checkbox.getAttribute('data-ingrediente-id');
  const inputAjuste = checkbox.closest('tr').querySelector('.input-ajuste');
  
  if (checkbox.checked) {
    // Habilitar el input y cambiar estilos
    inputAjuste.disabled = false;
    inputAjuste.style.backgroundColor = '#ffffff';
    inputAjuste.focus();
    console.log(`‚úÖ [AJUSTE] Habilitado ajuste para ingrediente ${ingredienteId}`);
  } else {
    // Deshabilitar el input, limpiar valor y cambiar estilos
    inputAjuste.disabled = true;
    inputAjuste.value = '';
    inputAjuste.style.backgroundColor = '#f5f5f5';
    console.log(`‚ùå [AJUSTE] Deshabilitado ajuste para ingrediente ${ingredienteId}`);
  }
}

async function guardarAjustes() {
  // Solo procesar ingredientes que tienen el checkbox marcado
  const checkboxesMarcados = tablaBody.querySelectorAll('.checkbox-ajuste:checked');
  const ajustes = [];

  console.log(`üîç [GUARDADO] Procesando ${checkboxesMarcados.length} ingredientes seleccionados para ajuste`);

  checkboxesMarcados.forEach(checkbox => {
    const fila = checkbox.closest('tr');
    const inputAjuste = fila.querySelector('.input-ajuste');
    const ingredienteId = checkbox.getAttribute('data-ingrediente-id');
    const cantidad = parseFloat(inputAjuste.value);

    if (!isNaN(cantidad) && cantidad >= 0) {
      ajustes.push({
        articulo_numero: ingredienteId,
        usuario_id: usuarioIdGlobal,
        tipo: 'ajuste puntual',
        kilos: cantidad,
        cantidad: Math.abs(cantidad), // Para compatibilidad con el endpoint
        observacion: `Ajuste manual selectivo desde guardado de ingredientes - Carro #${carroIdGlobal}`
      });
      console.log(`üìù [GUARDADO] Agregado ajuste: Ingrediente ${ingredienteId} ‚Üí ${cantidad}kg`);
    } else {
      console.warn(`‚ö†Ô∏è [GUARDADO] Valor inv√°lido para ingrediente ${ingredienteId}: ${inputAjuste.value}`);
    }
  });

  if (ajustes.length === 0) {
    alert('‚ÑπÔ∏è No hay ajustes v√°lidos para guardar.\n\nüí° Aseg√∫rese de:\n‚Ä¢ Marcar los checkboxes de los ingredientes a ajustar\n‚Ä¢ Ingresar valores num√©ricos v√°lidos');
    return;
  }

  // Mostrar confirmaci√≥n con resumen
  const resumen = ajustes.map(a => `‚Ä¢ Ingrediente ${a.articulo_numero}: ${a.kilos}kg`).join('\n');
  const confirmar = confirm(`üîÑ ¬øConfirmar ajustes selectivos?\n\nüìä Se ajustar√°n ${ajustes.length} ingredientes:\n\n${resumen}\n\n‚ö†Ô∏è Esta acci√≥n modificar√° el stock actual.`);
  
  if (!confirmar) {
    console.log('‚ùå [GUARDADO] Usuario cancel√≥ los ajustes');
    return;
  }

  try {
    console.log(`üíæ [GUARDADO] Guardando ${ajustes.length} ajustes selectivos...`);
    
    const response = await fetch('http://localhost:3002/api/produccion/ingredientes-ajustes/batch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ajustes })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || `Error ${response.status}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ [GUARDADO] Ajustes selectivos guardados:', result);
    
    alert(`‚úÖ Ajustes selectivos guardados correctamente!\n\nüìä ${result.ajustes_aplicados} ingredientes actualizados\nüéØ Solo se modificaron los ingredientes seleccionados`);
    cerrarModal();
  } catch (error) {
    console.error('‚ùå [GUARDADO] Error al guardar ajustes selectivos:', error);
    alert('‚ùå Error al guardar ajustes: ' + error.message);
  }
}
