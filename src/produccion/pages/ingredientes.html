<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Ingredientes - Gestiones Lamda</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/ingredientes-panel.css">
    <style>
        /* Estilos espec√≠ficos que no est√°n en el CSS externo */
        .btn-inventario {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-inventario:hover {
            background-color: #5a32a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }

        .btn-agregar {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-agregar:hover {
            background-color: var(--primary-dark, #0056b3);
        }

        .btn-editar, .btn-eliminar {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-editar {
            background-color: #ffc107;
            color: #000;
        }

        .btn-eliminar {
            background-color: #dc3545;
            color: white;
        }

        /* Estilos para selectores de sector inline */
        .selector-sector-inline:hover {
            border-color: #007bff !important;
        }

        .selector-sector-inline:disabled {
            cursor: wait !important;
            opacity: 0.6 !important;
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            cursor: move;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            position: sticky;
            float: right;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1;
            background: white;
            padding: 5px;
            margin-bottom: 10px;
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-actions {
            text-align: right;
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-imprimir {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }

        .btn-imprimir:hover {
            background-color: #138496;
        }

        .mensaje-error {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .mensaje-exito {
            background-color: #28a745;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Animaciones para mensajes discretos */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Ajuste del container principal para el nuevo layout */
        body > .container {
            max-width: 100%;
            padding: 0;
            margin: 0;
        }

        body > .container > header {
            padding: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }

        body > .container > footer {
            padding: 20px;
            background: white;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gesti√≥n de Ingredientes</h1>
            <a href="/pages/produccion.html" class="back-button">‚Üê Volver al espacio de trabajo</a>
        </header>

        <main class="ingredientes-container">
            <!-- PANEL IZQUIERDO: CONFIGURACI√ìN Y FILTROS -->
            <div class="panel-config" id="panel-config">
                <!-- Resizer Handle -->
                <div class="panel-resizer" id="panel-resizer"></div>
                
                <div class="config-header">
                    <h2>‚öôÔ∏è Filtros y Configuraci√≥n</h2>
                    <p>Personaliza la vista de ingredientes</p>
                </div>

                <div class="config-body">
                    <!-- ACORDE√ìN 1: SECTORES / DEP√ìSITOS -->
                    <div class="config-accordion">
                        <div class="accordion-header" onclick="toggleAccordion('sectores-depositos')">
                            <span>üè¢ Sectores y Dep√≥sitos</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content" id="accordion-sectores-depositos">
                            <div id="sectores-lista-container" class="sectores-lista">
                                <!-- Los sectores se cargar√°n din√°micamente aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <!-- ACORDE√ìN 2: FILTRO POR CATEGOR√çA -->
                    <div class="config-accordion">
                        <div class="accordion-header collapsed" onclick="toggleAccordion('categorias')">
                            <span>üì¶ Filtrar por Categor√≠a</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content collapsed" id="accordion-categorias">
                            <div class="filtros-botones-globales">
                                <button class="btn-filtro" id="btn-todas-categorias">Todas</button>
                                <button class="btn-filtro" id="btn-ninguna-categoria">Ninguna</button>
                            </div>
                            <div id="filtros-categorias-container" class="filtros-botones-container">
                                <!-- Los botones de categor√≠a se generar√°n din√°micamente aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <!-- ACORDE√ìN 3: FILTRO POR TIPO -->
                    <div class="config-accordion">
                        <div class="accordion-header collapsed" onclick="toggleAccordion('tipo')">
                            <span>üîß Filtrar por Tipo</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content collapsed" id="accordion-tipo">
                            <div id="filtros-tipo-container" class="filtros-botones-container">
                                <!-- Los botones de tipo se generar√°n din√°micamente aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <!-- ACORDE√ìN 4: FILTRO POR STOCK -->
                    <div class="config-accordion">
                        <div class="accordion-header collapsed" onclick="toggleAccordion('stock')">
                            <span>üìä Filtrar por Stock</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content collapsed" id="accordion-stock">
                            <div id="filtros-stock-container" class="filtros-botones-container">
                                <!-- Los botones de stock se generar√°n din√°micamente aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <!-- ACORDE√ìN 5: FILTRO POR SECTOR DE ALMACENAMIENTO -->
                    <div class="config-accordion">
                        <div class="accordion-header collapsed" onclick="toggleAccordion('sector-almacen')">
                            <span>üóÑÔ∏è Filtrar por Sector de Almacenamiento</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content collapsed" id="accordion-sector-almacen">
                            <div id="filtros-sectores-container" class="filtros-botones-container">
                                <!-- Los botones de sectores se generar√°n din√°micamente aqu√≠ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PANEL DERECHO: CONTENIDO PRINCIPAL -->
            <div class="panel-main">
                <div class="panel-main-content">
                    <div class="content-section">
                        <!-- Barra de acciones superior -->
                        <div class="actions-bar">
                            <h2>Lista de Ingredientes</h2>
                            <div class="actions-buttons">
                                <button id="btn-inventario-ingredientes" class="btn-inventario" onclick="abrirVentana('inventario-ingredientes.html', 'inventarioIngredientes')">
                                    üìã Inventario
                                </button>
                                <button id="btn-gestionar-sectores" class="btn-inventario" onclick="abrirVentana('sectores.html', 'gestionSectores')" style="background-color: #28a745;">
                                    üè¢ Gestionar Sectores
                                </button>
                                <button id="btn-nuevo-ingrediente" class="btn-agregar">+ Nuevo Ingrediente</button>
                            </div>
                        </div>

                        <!-- Filtro por nombre (√∫nico filtro en panel principal) -->
                        <div class="filtro-nombre-container">
                            <label for="filtro-nombre">üîç Buscar por nombre:</label>
                            <input type="text" id="filtro-nombre" placeholder="Escriba el nombre del ingrediente...">
                        </div>

                        <!-- Tabla de ingredientes -->
                        <table class="tabla-ingredientes">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Nombre</th>
                                    <th>Unidad de Medida</th>
                                    <th>Categor√≠a</th>
                                    <th id="columna-dinamica">Stock Actual</th>
                                    <th>Stock Potencial</th>
                                    <th>Sector</th>
                                    <th>Descripci√≥n</th>
                                    <th>Tipo</th>
                                    <th>Composici√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-ingredientes-body">
                                <!-- Los ingredientes se cargar√°n din√°micamente aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal para agregar/editar ingrediente -->
        <div id="modal-ingrediente" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="close-modal">&times;</span>
                    <h2 id="modal-titulo">Nuevo Ingrediente</h2>
                </div>
                <form id="form-ingrediente">
                    <input type="hidden" id="ingrediente-id">
                    <div class="form-group">
                        <label for="codigo">C√≥digo:</label>
                        <input type="text" id="codigo" readonly>
                        <small class="form-text text-muted">C√≥digo √∫nico generado autom√°ticamente</small>
                    </div>
                    <div class="form-group">
                        <label for="nombre">Nombre:</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="unidad-medida">Unidad de Medida:</label>
                        <input type="text" id="unidad-medida" placeholder="Ej: kilo, unidad, ml..." required>
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categor√≠a:</label>
                        <input type="text" id="categoria" placeholder="Ej: semillas, harinas, frutos secos..." required>
                    </div>
                    <div class="form-group">
                        <label for="stock">Stock Actual:</label>
                        <input type="number" id="stock" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="sector">Sector:</label>
                        <select id="sector">
                            <option value="">Sin sector asignado</option>
                            <!-- Los sectores se cargar√°n din√°micamente aqu√≠ -->
                        </select>
                        <small class="form-text text-muted">Seleccione un sector para organizar el ingrediente</small>
                    </div>
                    <div class="form-group">
                        <label for="descripcion">Descripci√≥n:</label>
                        <textarea id="descripcion" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-agregar">Guardar</button>
                        <button type="button" id="btn-imprimir" class="btn-imprimir">
                            Imprimir Etiqueta
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para composici√≥n del mix -->
        <div id="modal-mix" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="modal-mix-titulo">Composici√≥n del Mix</h5>
                    <span class="close-modal">&times;</span>
                </div>
                
                <!-- Secci√≥n de agregar ingrediente (compacta en una l√≠nea) -->
                <div class="agregar-ingrediente-row">
                    <div class="input-ingrediente-wrapper">
                        <input 
                            type="text" 
                            id="buscar-ingrediente-mix" 
                            placeholder="Buscar ingrediente..."
                            autocomplete="off"
                        >
                        <ul id="lista-resultados-mix" class="lista-resultados-mix"></ul>
                    </div>
                    <input 
                        type="number" 
                        id="cantidad-ingrediente-mix" 
                        placeholder="Kg"
                        step="0.001" 
                        min="0.001"
                    >
                    <button id="btn-agregar-a-mix" class="btn-agregar-inline" title="Agregar ingrediente">+</button>
                </div>
                
                <!-- Tabla de composici√≥n actual -->
                <div class="tabla-mix-container">
                    <table class="tabla-mix-ingredientes">
                        <thead>
                            <tr>
                                <th>Ingrediente</th>
                                <th>Cantidad</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tabla-mix-ingredientes-body">
                            <!-- Los ingredientes del mix se cargar√°n din√°micamente aqu√≠ -->
                        </tbody>
                        <tfoot>
                            <tr class="fila-total">
                                <td><strong>TOTAL</strong></td>
                                <td><strong id="total-kilos-mix">0.00 Kilo</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Bot√≥n de guardar -->
                <div class="modal-footer">
                    <button id="btn-guardar-mix" class="btn-guardar-mix">
                        Guardar Receta
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2024 Gestiones Lamda</p>
        </footer>
    </div>

    <script type="module" src="/js/ingredientes.js"></script>
    <script type="module" src="/js/mix.js"></script>
    <script>
        // ============================================
        // FUNCIONES DE ACORDE√ìN
        // ============================================
        function toggleAccordion(accordionId) {
            const header = event.currentTarget;
            const content = document.getElementById(`accordion-${accordionId}`);
            
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // ============================================
        // FUNCIONALIDAD DE RESIZE DEL PANEL
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const resizer = document.getElementById('panel-resizer');
            const panel = document.getElementById('panel-config');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const newWidth = e.clientX;
                if (newWidth >= 250 && newWidth <= 600) {
                    panel.style.width = newWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        });

        // ============================================
        // SISTEMA DE SECTORES/USUARIOS (MIGRADO AL PANEL LATERAL)
        // ============================================
        let usuariosConStock = [];
        let tabActiva = 'deposito';

        // Inicializar sistema de sectores
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inicializando sistema de sectores...');
            
            // Cargar usuarios con stock y crear lista en panel lateral
            await inicializarSectoresPanel();
            
            // Activar dep√≥sito por defecto
            await activarTabDeposito();
        });

        // Funci√≥n para cargar usuarios con stock y crear lista en panel
        async function inicializarSectoresPanel() {
            try {
                console.log('üîç Cargando usuarios con stock...');
                const response = await fetch('http://localhost:3002/api/produccion/ingredientes/usuarios-con-stock');
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è No se pudieron cargar usuarios con stock');
                    return;
                }
                
                usuariosConStock = await response.json();
                console.log(`‚úÖ Encontrados ${usuariosConStock.length} usuarios con stock`);
                
                // Renderizar lista de sectores en el panel
                renderizarSectoresPanel();
                
            } catch (error) {
                console.error('‚ùå Error al cargar usuarios con stock:', error);
            }
        }

        // Funci√≥n para renderizar sectores en el panel lateral
        function renderizarSectoresPanel() {
            const container = document.getElementById('sectores-lista-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Crear item para Dep√≥sito
            const depositoItem = document.createElement('div');
            depositoItem.className = 'sector-item activo';
            depositoItem.dataset.tab = 'deposito';
            depositoItem.textContent = 'üì¶ Dep√≥sito';
            depositoItem.onclick = () => activarSector(depositoItem, 'deposito');
            container.appendChild(depositoItem);
            
            // Crear items para usuarios con stock
            usuariosConStock.forEach(usuario => {
                const item = document.createElement('div');
                item.className = 'sector-item';
                item.dataset.tab = `usuario-${usuario.usuario_id}`;
                item.dataset.usuarioId = usuario.usuario_id;
                item.textContent = `üë§ ${usuario.nombre_completo}`;
                item.onclick = () => activarSector(item, `usuario-${usuario.usuario_id}`, usuario.usuario_id);
                container.appendChild(item);
            });
        }

        // Funci√≥n para activar un sector
        function activarSector(element, tabId, usuarioId = null) {
            // Actualizar estado visual
            document.querySelectorAll('.sector-item').forEach(item => {
                item.classList.remove('activo');
            });
            element.classList.add('activo');
            
            // Activar la vista correspondiente
            if (usuarioId) {
                activarTabUsuario(usuarioId);
            } else {
                activarTabDeposito();
            }
        }

        // Funci√≥n para activar tab de dep√≥sito
        async function activarTabDeposito() {
            console.log('üîÑ Activando vista de dep√≥sito...');
            
            tabActiva = 'deposito';
            
            // Actualizar encabezado de columna
            const columnaDinamica = document.getElementById('columna-dinamica');
            if (columnaDinamica) {
                columnaDinamica.textContent = 'Stock Actual';
            }
            
            // Cargar ingredientes del dep√≥sito
            if (window.cargarIngredientes) {
                await window.cargarIngredientes();
            }
        }

        // Funci√≥n para activar tab de usuario
        async function activarTabUsuario(usuarioId) {
            console.log(`üîÑ Activando vista de usuario ${usuarioId}...`);
            
            tabActiva = `usuario-${usuarioId}`;
            
            // Actualizar encabezado de columna
            const columnaDinamica = document.getElementById('columna-dinamica');
            if (columnaDinamica) {
                columnaDinamica.textContent = 'Stock Personal';
            }
            
            // Cargar stock del usuario
            await cargarStockUsuario(usuarioId);
        }

        // Funci√≥n para cargar stock de usuario
        async function cargarStockUsuario(usuarioId) {
            try {
                console.log(`üîç Cargando stock para usuario ${usuarioId}...`);
                const response = await fetch(`http://localhost:3002/api/produccion/ingredientes/stock-usuario/${usuarioId}`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar stock del usuario');
                }
                
                const stockUsuario = await response.json();
                console.log(`‚úÖ Stock cargado:`, stockUsuario);
                
                // Renderizar tabla
                renderizarTablaUsuario(stockUsuario);
                
                // Limpiar filtros
                limpiarFiltros();
                
            } catch (error) {
                console.error(`‚ùå Error al cargar stock del usuario ${usuarioId}:`, error);
                mostrarError('No se pudo cargar el stock del usuario');
            }
        }

        // Funci√≥n para renderizar tabla de usuario
        function renderizarTablaUsuario(stockUsuario) {
            const tbody = document.getElementById('tabla-ingredientes-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!stockUsuario || stockUsuario.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Este usuario no tiene stock de ingredientes</td></tr>';
                return;
            }
            
            stockUsuario.forEach(item => {
                const row = document.createElement('tr');
                
                let tipoOrigen = 'Simple';
                if (item.origen_mix_id !== null && item.origen_mix_id !== undefined) {
                    tipoOrigen = 'Sobrante de Mix';
                }
                
                row.innerHTML = `
                    <td>${item.nombre_ingrediente}</td>
                    <td>${item.unidad_medida || '-'}</td>
                    <td>${item.categoria || '-'}</td>
                    <td>${parseFloat(item.stock_total).toFixed(3)}</td>
                    <td>-</td>
                    <td>${item.descripcion || '-'}</td>
                    <td>${tipoOrigen}</td>
                    <td>-</td>
                    <td><span style="color: #6c757d; font-style: italic;">Solo lectura</span></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Funci√≥n para limpiar filtros
        function limpiarFiltros() {
            const containers = [
                'filtros-categorias-container',
                'filtros-tipo-container',
                'filtros-stock-container',
                'filtros-sectores-container'
            ];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '<p class="text-muted">Los filtros no est√°n disponibles en la vista de usuario</p>';
                }
            });
        }

        // Funci√≥n para mostrar errores
        function mostrarError(mensaje) {
            const contenedor = document.querySelector('.content-section');
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = 'mensaje-error';
            mensajeDiv.textContent = mensaje;
            
            const mensajeAnterior = document.querySelector('.mensaje-error, .mensaje-exito');
            if (mensajeAnterior) {
                mensajeAnterior.remove();
            }
            
            contenedor.insertBefore(mensajeDiv, contenedor.firstChild);
            
            setTimeout(() => {
                mensajeDiv.remove();
            }, 5000);
        }

        // Hacer funciones disponibles globalmente
        window.tabActiva = () => tabActiva;
        window.activarTabDeposito = activarTabDeposito;
        window.activarTabUsuario = activarTabUsuario;
    </script>
</body>
</html>
