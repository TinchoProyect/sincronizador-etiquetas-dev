<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendientes de Compra - Gestiones Lamda</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        .pendientes-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .pendientes-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .pendientes-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .tabla-pendientes {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .tabla-pendientes thead {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color-dark, #5092a7));
            color: white;
        }

        .tabla-pendientes th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .tabla-pendientes td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }

        .tabla-pendientes tbody tr:hover {
            background-color: #f8f9fa;
        }

        .badge-estado {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-en-espera {
            background-color: #fff3cd;
            color: #856404;
        }

        .articulo-derivado {
            background-color: #ffcccc !important;
            border-left: 6px solid #dc3545 !important;
            box-shadow: inset 0 0 0 1px #dc3545;
        }

        .articulo-derivado td {
            font-weight: 700 !important;
            color: #721c24 !important;
        }

        .articulo-derivado td:first-child {
            background-color: #dc3545 !important;
            color: white !important;
            font-weight: 800 !important;
        }

        .contador-badge {
            display: inline-block;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1.5em;
            font-weight: bold;
            margin-left: 15px;
            box-shadow: 0 3px 8px rgba(220, 53, 69, 0.3);
        }

        .contador-header {
            font-size: 3em;
            color: #dc3545;
            font-weight: bold;
            margin: 0 10px;
        }

        .mensaje-vacio {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 16px;
        }

        .mensaje-vacio span {
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }

        .mensaje-error {
            text-align: center;
            padding: 40px 20px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pendientes de Compra</h1>
            <a href="produccion.html" class="back-button">‚Üê Volver a Producci√≥n</a>
        </header>

        <main class="pendientes-container">
            <div class="pendientes-header">
                <h1>üõí Art√≠culos Pendientes de Compra <span id="contador-header" class="contador-header">0</span></h1>
                <p style="color: #6c757d;">Presupuestos con art√≠culos derivados desde el Resumen de Faltantes</p>
            </div>

            <div id="tabla-container">
                <p style="text-align: center; padding: 40px; color: #6c757d;">Cargando...</p>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 Gestiones Lamda</p>
        </footer>
    </div>

    <script>
        async function cargarPendientes() {
            const container = document.getElementById('tabla-container');
            
            try {
                const response = await fetch('/api/produccion/compras/pendientes');
                const result = await response.json();

                if (!result.success) {
                    container.innerHTML = `
                        <div class="mensaje-error">
                            <strong>Error:</strong> ${result.error || 'No se pudieron cargar los pendientes'}
                        </div>
                    `;
                    return;
                }

                const pendientes = result.data.filter(p => p.estado === 'En espera') || [];
                
                console.log('üìä [PENDIENTES-COMPRA] Total pendientes cargados:', pendientes.length);
                console.log('üìä [PENDIENTES-COMPRA] Datos RAW del backend:', result.data);
                pendientes.forEach(p => {
                    console.log('  üî¥ [PENDIENTE-DERIVADO]:', {
                        id: p.id,
                        articulo_numero: p.articulo_numero,
                        codigo_barras: p.codigo_barras,
                        codigo_barras_real: p.codigo_barras_real,
                        id_presupuesto_local: p.id_presupuesto_local,
                        presupuesto_estado: p.presupuesto_estado,
                        presupuesto_secuencia: p.presupuesto_secuencia
                    });
                });

                if (pendientes.length === 0) {
                    container.innerHTML = `
                        <div class="mensaje-vacio">
                            <span>‚úÖ</span>
                            <p>No hay art√≠culos pendientes de compra</p>
                        </div>
                    `;
                    return;
                }

                const idsPresupuestos = [...new Set(pendientes.map(p => p.id_presupuesto_local))];
                
                console.log('üîç Consultando presupuestos con IDs:', idsPresupuestos);
                
                const presupuestosResponse = await fetch(`/api/produccion/pedidos-por-cliente?ids=${idsPresupuestos.join(',')}`);
                const presupuestosData = await presupuestosResponse.json();
                
                console.log('üìä Respuesta presupuestos:', presupuestosData);
                
                if (!presupuestosData.success || !presupuestosData.data) {
                    throw new Error('No se pudieron cargar datos de presupuestos');
                }

                // VALIDACI√ìN: Verificar que presupuestos existan Y est√©n activos
                const validacionResponse = await fetch(`/api/produccion/validar-presupuestos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids_presupuestos: idsPresupuestos })
                });
                
                const validacionData = await validacionResponse.json();
                
                if (validacionData.success && validacionData.presupuestos_invalidos.length > 0) {
                    console.warn('‚ö†Ô∏è Presupuestos inv√°lidos detectados:', validacionData.presupuestos_invalidos);
                    
                    // Marcar como obsoletos autom√°ticamente
                    try {
                        for (const invalido of validacionData.presupuestos_invalidos) {
                            const pendientesObsoletos = pendientes.filter(p => p.id_presupuesto_local === invalido.id);
                            
                            for (const pendiente of pendientesObsoletos) {
                                await fetch(`/api/produccion/compras/pendientes/${pendiente.id}/obsoleto`, {
                                    method: 'PATCH'
                                });
                            }
                        }
                        
                        console.log('‚úÖ Pendientes obsoletos marcados autom√°ticamente');
                        
                        // Recargar para mostrar solo los v√°lidos
                        setTimeout(() => cargarPendientes(), 1000);
                        return;
                    } catch (error) {
                        console.error('Error al marcar obsoletos:', error);
                    }
                }

                // Filtrar solo presupuestos v√°lidos para renderizar
                const presupuestosValidos = new Set(validacionData.presupuestos_validos.map(p => p.id));
                const presupuestosEncontrados = new Set();
                
                presupuestosData.data.forEach(cliente => {
                    cliente.articulos.forEach(art => {
                        const idLocal = art.id_presupuesto_local || art.presupuesto_id_local;
                        if (idLocal && presupuestosValidos.has(idLocal)) {
                            presupuestosEncontrados.add(idLocal);
                        }
                    });
                });

                // Crear mapa de pendientes usando CODIGO_BARRAS + id_presupuesto_local
                const pendientesMap = new Map();
                pendientes.forEach(p => {
                    // CLAVE: codigo_barras_real (o codigo_barras) + id_presupuesto_local
                    // Esto coincide con articulo_numero que viene en los presupuestos (que es el c√≥digo de barras)
                    const codigoBarras = p.codigo_barras_real || p.codigo_barras || p.articulo_numero;
                    const key = `${codigoBarras}_${p.id_presupuesto_local}`;
                    pendientesMap.set(key, p);
                    console.log('üìå [MAPA-PENDIENTES] Agregando clave:', {
                        clave: key,
                        id_pendiente: p.id,
                        codigo_barras_usado: codigoBarras,
                        articulo_numero_original: p.articulo_numero,
                        id_presupuesto_local: p.id_presupuesto_local,
                        tipo_codigo: typeof codigoBarras,
                        tipo_presupuesto: typeof p.id_presupuesto_local
                    });
                });
                
                console.log(`üìä [MAPA-PENDIENTES] Total claves en mapa: ${pendientesMap.size}`);
                console.log(`üìä [MAPA-PENDIENTES] Todas las claves:`, Array.from(pendientesMap.keys()));

                const html = presupuestosData.data.map(cliente => {
                    const presupuestosMap = new Map();
                    
                    cliente.articulos.forEach((articulo, idx) => {
                        // Log del primer art√≠culo para ver qu√© campos tiene
                        if (idx === 0) {
                            console.log('üîç [PRIMER-ARTICULO] Campos disponibles:', Object.keys(articulo));
                            console.log('üîç [PRIMER-ARTICULO] Datos completos:', articulo);
                        }
                        
                        const presupId = articulo.presupuesto_id;
                        if (!presupuestosMap.has(presupId)) {
                            // Buscar id_presupuesto_local en diferentes campos posibles
                            const idLocal = articulo.id_presupuesto_local || 
                                          articulo.presupuesto_id_local || 
                                          articulo.presupuesto_local ||
                                          articulo.id_local;
                            
                            console.log(`üìã [CREAR-PRESUPUESTO] ID: ${presupId}, id_local encontrado:`, idLocal);
                            
                            presupuestosMap.set(presupId, {
                                presupuesto_id: presupId,
                                presupuesto_id_local: idLocal,
                                presupuesto_fecha: articulo.presupuesto_fecha,
                                articulos: []
                            });
                        }
                        presupuestosMap.get(presupId).articulos.push(articulo);
                    });
                    
                    console.log('üìä Presupuestos mapeados:', Array.from(presupuestosMap.values()).map(p => ({
                        id: p.presupuesto_id,
                        id_local: p.presupuesto_id_local,
                        articulos: p.articulos.length
                    })));
                    
                    const presupuestos = Array.from(presupuestosMap.values());
                    
                    return `
                        <div class="cliente-acordeon">
                            <div class="cliente-header" onclick="toggleCliente('cliente-${cliente.cliente_id}')" style="padding: 15px; background-color: #e9ecef; cursor: pointer; font-weight: bold;">
                                <span class="indicador-estado indicador-${cliente.indicador_estado.toLowerCase()}">${cliente.indicador_estado}</span>
                                ${cliente.cliente_nombre} (${cliente.total_articulos} art√≠culos, ${cliente.total_presupuestos} presupuestos)
                            </div>
                            <div id="cliente-${cliente.cliente_id}" class="cliente-contenido" style="display: none; padding: 10px;">
                                ${presupuestos.map((presupuesto, idx) => {
                                    const fechaFormateada = new Date(presupuesto.presupuesto_fecha).toLocaleDateString('es-AR');
                                    
                                    return `
                                        <div style="margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;">
                                            <div onclick="togglePresupuesto('presupuesto-${cliente.cliente_id}-${idx}')" style="padding: 12px 15px; background-color: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <strong>Presupuesto ${presupuesto.presupuesto_id}</strong>
                                                    <span style="color: #6c757d; margin-left: 10px;">üìÖ ${fechaFormateada}</span>
                                                    <span style="color: #6c757d; margin-left: 10px;">(${presupuesto.articulos.length} art√≠culos)</span>
                                                </div>
                                                <span class="toggle-icon" style="font-size: 1.2em;">‚ñº</span>
                                            </div>
                                            <div id="presupuesto-${cliente.cliente_id}-${idx}" style="display: none;">
                                                <table class="articulos-tabla">
                                                    <thead>
                                                        <tr>
                                                            <th>Art√≠culo</th>
                                                            <th>Descripci√≥n</th>
                                                            <th>Cantidad</th>
                                                            <th>Stock</th>
                                                            <th>Faltante</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${presupuesto.articulos.map(articulo => {
                                                            // CORRECCI√ìN: Solo marcar en rojo si fue DERIVADO a compra
                                                            const faltante = parseFloat(articulo.faltante) || 0;
                                                            const articuloNumero = articulo.articulo_numero;
                                                            
                                                            // CORRECCI√ìN: Usar presupuesto_id_local del objeto presupuesto padre
                                                            const presupuestoIdLocal = presupuesto.presupuesto_id_local;
                                                            
                                                            // Buscar si este art√≠culo espec√≠fico fue derivado a compra
                                                            // Probar con articulo_numero (c√≥digo de art√≠culo)
                                                            const key = `${articuloNumero}_${presupuestoIdLocal}`;
                                                            let pendiente = pendientesMap.get(key);
                                                            let fueDerivado = !!pendiente;
                                                            
                                                            console.log(`üîç [RENDER-ARTICULO] ${articulo.descripcion.substring(0, 30)}:`, {
                                                                articulo_numero: articuloNumero,
                                                                tipo_articulo: typeof articuloNumero,
                                                                presupuesto_local: presupuestoIdLocal,
                                                                tipo_presupuesto: typeof presupuestoIdLocal,
                                                                clave_generada: key,
                                                                faltante: faltante,
                                                                pendiente_encontrado: pendiente ? { id: pendiente.id, articulo: pendiente.articulo_numero } : null,
                                                                fueDerivado: fueDerivado,
                                                                seMarcaraRojo: fueDerivado,
                                                                existe_en_mapa: pendientesMap.has(key),
                                                                todas_claves_mapa: Array.from(pendientesMap.keys())
                                                            });
                                                            
                                                            return `
                                                                <tr ${fueDerivado ? 'class="articulo-derivado"' : ''}>
                                                                    <td>${articulo.articulo_numero}</td>
                                                                    <td>${articulo.descripcion}</td>
                                                                    <td>${parseFloat(articulo.pedido_total).toFixed(2)}</td>
                                                                    <td>${parseFloat(articulo.stock_disponible).toFixed(2)}</td>
                                                                    <td class="${articulo.faltante > 0 ? 'cantidad-faltante' : 'cantidad-completa'}">${parseFloat(articulo.faltante).toFixed(2)}</td>
                                                                    <td>
                                                                        ${fueDerivado ? `<button class="admin-button" style="background-color: #ffc107; padding: 6px 12px; font-size: 12px;" onclick="revertirPendiente(${pendiente.id})">‚Ü©Ô∏è Revertir</button>` : '-'}
                                                                    </td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;

                // CORRECCI√ìN: Mostrar cantidad de ART√çCULOS derivados, no presupuestos
                const contadorHeader = document.getElementById('contador-header');
                if (contadorHeader) {
                    contadorHeader.textContent = pendientes.length;
                    console.log(`üìä [CONTADOR-HEADER] Mostrando ${pendientes.length} art√≠culos derivados (de ${idsPresupuestos.length} presupuestos)`);
                }

            } catch (error) {
                console.error('Error al cargar pendientes:', error);
                container.innerHTML = `
                    <div class="mensaje-error">
                        <strong>Error:</strong> No se pudieron cargar los pendientes de compra
                    </div>
                `;
            }
        }

        function toggleCliente(clienteId) {
            const contenido = document.getElementById(clienteId);
            if (contenido) {
                contenido.style.display = contenido.style.display === 'none' ? 'block' : 'none';
            }
        }

        function togglePresupuesto(presupuestoId) {
            const contenido = document.getElementById(presupuestoId);
            const header = document.querySelector(`[onclick="togglePresupuesto('${presupuestoId}')"]`);
            const icon = header ? header.querySelector('.toggle-icon') : null;
            
            if (contenido) {
                if (contenido.style.display === 'none' || contenido.style.display === '') {
                    contenido.style.display = 'block';
                    if (icon) icon.style.transform = 'rotate(180deg)';
                } else {
                    contenido.style.display = 'none';
                    if (icon) icon.style.transform = 'rotate(0deg)';
                }
            }
        }

        async function revertirPendiente(id) {
            if (!confirm('¬øRevertir esta derivaci√≥n?')) return;

            try {
                const response = await fetch(`/api/produccion/compras/pendientes/${id}/revertir`, {
                    method: 'PATCH'
                });

                const result = await response.json();

                if (!result.success) {
                    alert('Error: ' + (result.error || 'No se pudo revertir'));
                    return;
                }

                alert('Revertido');
                cargarPendientes();

            } catch (error) {
                console.error('Error al revertir:', error);
                alert('Error al revertir');
            }
        }

        document.addEventListener('DOMContentLoaded', cargarPendientes);
    </script>
</body>
</html>
