<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producci√≥n - Gestiones Lamda</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        .lista-colaboradores {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .colaborador-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .colaborador-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .colaborador-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .colaborador-nombre {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
            margin: 0;
        }

        .mensaje-info {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .mensaje-error {
            text-align: center;
            color: #dc3545;
            padding: 20px;
        }

        .admin-buttons {
            text-align: center;
            margin: 20px 0;
        }

        .admin-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .admin-button:hover {
            background-color:var(--secondary-color-dark, #5092a7);
        }

        /* Estilos para la secci√≥n de pedidos por cliente */
        .pedidos-por-cliente-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .pedidos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pedidos-header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .pedidos-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pedidos-controls label {
            font-weight: bold;
            color: var(--text-color);
        }

        .pedidos-controls input[type="date"],
        .pedidos-controls input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .pedidos-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
        }

        .cliente-acordeon {
            border-bottom: 1px solid #dee2e6;
        }

        .cliente-acordeon:last-child {
            border-bottom: none;
        }

        .cliente-header {
            padding: 15px;
            background-color: #e9ecef;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .cliente-header:hover {
            background-color: #dee2e6;
        }

        .cliente-contenido {
            display: none;
            padding: 0;
        }

        .articulos-tabla {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .articulos-tabla th,
        .articulos-tabla td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .articulos-tabla th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: var(--text-color);
        }

        .cantidad-faltante {
            color: #dc3545;
            font-weight: bold;
        }

        .cantidad-completa {
            color: #28a745;
            font-weight: bold;
        }

        .indicador-estado {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .indicador-completo {
            background-color: #d4edda;
            color: #155724;
        }

        .indicador-parcial {
            background-color: #fff3cd;
            color: #856404;
        }

        .indicador-faltantes {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Estilos para el modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #dc3545;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-body label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }

        .modal-body select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .faltantes-lista {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
            border-radius: 0 0 8px 8px;
            text-align: right;
        }

        .mensaje-exito {
            color: #28a745;
            font-weight: bold;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin: 10px 0;
        }

        .mensaje-error {
            color: #dc3545;
            font-weight: bold;
            padding: 10px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 10px 0;
        }

        .mensaje-info {
            color: #0c5460;
            font-weight: bold;
            padding: 10px;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            margin: 10px 0;
        }

        /* Estilos para las nuevas secciones */
        .header-section {
            margin-bottom: 30px;
        }

        .section-separator {
            height: 2px;
            background: linear-gradient(to right, transparent, var(--primary-color), transparent);
            margin: 40px 0;
            border-radius: 1px;
        }

        .reports-section {
            margin-top: 30px;
        }

        .reports-section::before {
            content: "üìä Informes de Presupuestos";
            display: block;
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        /* Estilos para secciones colapsables */
        .collapsible-section {
            padding: 0;
            margin: 20px 0;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }

        .section-toggle {
            width: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            padding: 20px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border-bottom: 1px solid #dee2e6;
        }

        .section-toggle:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-toggle h2 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2em;
            font-weight: bold;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-icon {
            font-size: 1.2em;
            color: var(--primary-color);
            transition: transform 0.3s ease;
            font-weight: bold;
        }

        .section-toggle[aria-expanded="true"] .toggle-icon {
            transform: rotate(90deg);
        }
        
        /* Estilos para contadores de secuencia - DESTACADOS */
        .contador-secuencia {
            font-weight: bold;
            color: #fff;
            font-size: 2em;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color-dark, #5092a7));
            padding: 10px 24px;
            border-radius: 30px;
            min-width: 70px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .contador-secuencia:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .collapsible-content {
            padding: 20px;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .collapsible-content.expanding {
            animation: expandSection 0.3s ease-out;
        }

        .collapsible-content.collapsing {
            animation: collapseSection 0.3s ease-in;
        }

        @keyframes expandSection {
            from {
                opacity: 0;
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
                padding-top: 20px;
                padding-bottom: 20px;
            }
        }

        @keyframes collapseSection {
            from {
                opacity: 1;
                max-height: 1000px;
                padding-top: 20px;
                padding-bottom: 20px;
            }
            to {
                opacity: 0;
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
        }

        /* Ajustes para el header dentro del contenido colapsable */
        .collapsible-content .pedidos-header {
            margin-bottom: 20px;
            justify-content: center;
        }

        /* Estilos para la secci√≥n de resumen */
        .summary-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .summary-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2em;
            font-weight: bold;
        }

        .summary-container {
            min-height: 60px;
        }

        .summary-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .summary-message span {
            font-size: 1.1em;
        }

        .summary-table {
            margin: 0;
            background-color: white;
        }

        .summary-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .summary-table td {
            font-size: 0.9em;
            padding: 10px 12px;
        }

        /* Ocultar columna Art√≠culo (c√≥digo de barras) */
        .summary-table .col-articulo {
            display: none;
        }

        /* Estilos para filas expandibles de art√≠culos compuestos */
        .summary-table .parent-row {
            transition: background-color 0.2s ease;
        }

        .summary-table .parent-row.has-children {
            border-left: 4px solid #17a2b8;
        }

        .summary-table .parent-row.has-children:hover {
            background-color: rgba(23, 162, 184, 0.1) !important;
        }

        .summary-table .expand-indicator {
            display: inline-block;
            font-size: 14px;
            transition: transform 0.3s ease;
            user-select: none;
        }

        /* Fila hijo (subfila) */
        .summary-table .child-row {
            display: none;
            background-color: #f0f8ff;
            border-left: 6px solid #17a2b8;
            animation: slideDown 0.3s ease-out;
        }

        .summary-table .child-row.visible {
            display: table-row;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .summary-table .child-row td {
            padding: 10px 12px 10px 50px;
            font-size: 0.9em;
            color: #2c5f6f;
            background: linear-gradient(90deg, rgba(23, 162, 184, 0.05) 0%, transparent 50%);
        }

        .summary-table .child-description {
            color: #2c5f6f;
            font-weight: 500;
        }

        .summary-table .child-label {
            display: inline-block;
            padding: 3px 8px;
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border-radius: 4px;
            font-size: 0.75em;
            margin-right: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .summary-table .descripcion-col {
            font-weight: 500;
        }

        .summary-table .parent-row.has-children .descripcion-col {
            font-weight: 600;
            color: #17a2b8;
        }

        /* Estilos compactos para el resumen */
        .summary-table .articulos-tabla th,
        .summary-table .articulos-tabla td {
            padding: 8px 10px;
        }

        /* Destacar filas de faltantes y parciales en el resumen */
        .summary-table tr.faltante-row {
            background-color: rgba(248, 215, 218, 0.3);
        }

        .summary-table tr.parcial-row {
            background-color: rgba(255, 243, 205, 0.3);
        }

        .summary-table tr.faltante-row:hover {
            background-color: rgba(248, 215, 218, 0.5);
        }

        .summary-table tr.parcial-row:hover {
            background-color: rgba(255, 243, 205, 0.5);
        }

        /* Separador entre grupos en el resumen */
        .summary-group-separator {
            height: 2px;
            background-color: #dee2e6;
            margin: 0;
        }

        .summary-group-separator td {
            padding: 0;
            border: none;
        }

        /* Estilos para el bot√≥n Pack y modal */
        .pack-button {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }

        .pack-button:hover {
            background-color: #5a2d91;
        }

        .modal-pack-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-pack-content {
            background-color: white;
            border-radius: 8px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .modal-pack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .modal-pack-header h3 {
            margin: 0;
            color: #6f42c1;
        }

        .modal-pack-body {
            padding: 20px;
        }

        .modal-pack-body label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }

        .modal-pack-body input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .modal-pack-body input:read-only {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .modal-pack-footer {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
            border-radius: 0 0 8px 8px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .pack-save-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .pack-save-button:hover {
            background-color: #218838;
        }

        .pack-remove-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .pack-remove-button:hover {
            background-color: #c82333;
        }

        .pack-cancel-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .pack-cancel-button:hover {
            background-color: #5a6268;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1100;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background-color: #dc3545;
        }


        /* Estilos para modal de armar pedido */
        .modal-armar-grande {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .scanner-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #007bff;
        }

        .scanner-section label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #007bff;
        }

        .scanner-section input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #007bff;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .scanner-section input:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .feedback-message {
            margin-top: 10px;
            padding: 12px;
            border-radius: 4px;
            display: none;
            font-weight: bold;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feedback-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .feedback-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .progress-section {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .articulos-verificacion {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .tabla-verificacion {
            margin: 0;
        }

        .tabla-verificacion tbody tr {
            transition: background-color 0.3s ease;
        }

        .articulo-confirmado {
            background: #d4edda !important;
        }

        .articulo-pendiente {
            background: #fff !important;
        }

        .estado-check {
            font-size: 24px;
            text-align: center;
        }

        .btn-confirmar-pedido {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-confirmar-pedido:hover:not(:disabled) {
            background: #218838;
        }

        .btn-confirmar-pedido:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-marcar-manual {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-marcar-manual:hover {
            background: #e0a800;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .pedidos-header {
                flex-direction: column;
                align-items: stretch;
            }

            .pedidos-controls {
                justify-content: center;
            }

            .articulos-tabla {
                font-size: 12px;
            }

            .articulos-tabla th,
            .articulos-tabla td {
                padding: 8px 4px;
            }

            .admin-button {
                padding: 6px 10px;
                font-size: 12px;
                margin: 2px;
            }

            .section-separator {
                margin: 20px 0;
            }

            .reports-section::before {
                font-size: 1.1em;
                margin-bottom: 15px;
            }

            .modal-pack-content {
                width: 95%;
                max-width: none;
            }

            .modal-pack-footer {
                flex-direction: column;
            }

            .pack-button {
                padding: 2px 6px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Producci√≥n - Abrir Instancia de Producci√≥n</h1>
            <a href="http://localhost:3000" class="back-button">‚Üê Volver al inicio</a>
        </header>

<main>
    <!-- Secci√≥n de Encabezado Principal -->
    <section class="header-section">
        <div class="welcome-section">
            <h2>Seleccione su nombre para iniciar su espacio de trabajo de producci√≥n</h2>
            
            <div class="admin-buttons">
                <a href="ingredientes.html" class="admin-button">
                    Gestionar Ingredientes
                </a>
                <a href="articulos.html" class="admin-button" style="margin-left: 10px;">
                    Gesti√≥n de Art√≠culos
                </a>
            </div>
            
            <div id="lista-colaboradores" class="lista-colaboradores">
                <!-- Los colaboradores se cargar√°n din√°micamente aqu√≠ -->
            </div>
        </div>
    </section>

    <!-- Separador Visual -->
    <div class="section-separator"></div>

    <!-- Resumen de Faltantes y Parciales -->
    <section class="summary-section">
        <div class="summary-header">
            <h3>‚ö†Ô∏è Resumen de Faltantes y Parciales</h3>
        </div>
        <div id="summary-container" class="summary-container">
            <div id="summary-loading" class="summary-message">
                <span>Cargando resumen...</span>
            </div>
            <div id="summary-empty" class="summary-message" style="display: none;">
                <span>‚úÖ Sin faltantes ni parciales</span>
            </div>
            <div id="summary-content" style="display: none;">
                <table class="articulos-tabla summary-table">
                    <thead>
                        <tr>
                            <th class="col-articulo">Art√≠culo</th>
                            <th>Descripci√≥n</th>
                            <th>Pedido Total</th>
                            <th>Stock Disponible</th>
                            <th>Faltante</th>
                            <th>Estado</th>
                            <th style="width: 100px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="summary-tbody">
                        <!-- Filas se cargar√°n din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Secci√≥n de Informes de Presupuestos -->
    <section class="reports-section">
        <!-- 1. Imprimir / Imprimir Modificado -->
        <section class="pedidos-por-cliente-section collapsible-section">
            <button class="section-toggle" onclick="toggleSection('pedidos-imprimir-section')" aria-expanded="false">
                <span class="toggle-icon">‚ñ∂</span>
                <h2>üìÑ Imprimir / Imprimir Modificado <span id="contador-imprimir" class="contador-secuencia">(0)</span></h2>
            </button>
            
            <div id="pedidos-imprimir-section" class="collapsible-content" style="display: none;">
                <div class="pedidos-header">
                    <div class="pedidos-controls">
                        <label for="fecha-corte">Fecha l√≠mite:</label>
                        <input type="date" id="fecha-corte" name="fecha-corte" />
                        <input type="text" id="buscar-cliente" placeholder="Buscar cliente..." />
                        <button id="refresh-pedidos" class="admin-button">Actualizar</button>
                        <button id="imprimir-todos-general" class="admin-button" style="background-color: #28a745;">üìÑ Imprimir Todos</button>
                    </div>
                </div>
                <div id="pedidos-imprimir" class="pedidos-container">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </section>

        <!-- 2. Armar Pedido -->
        <section class="pedidos-por-cliente-section collapsible-section">
            <button class="section-toggle" onclick="toggleSection('pedidos-armar-section')" aria-expanded="false">
                <span class="toggle-icon">‚ñ∂</span>
                <h2>üì¶ Armar Pedido <span id="contador-armar" class="contador-secuencia">(0)</span></h2>
            </button>
            
            <div id="pedidos-armar-section" class="collapsible-content" style="display: none;">
                <div id="pedidos-armar" class="pedidos-container">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </section>

        <!-- 3. Pedido Listo -->
        <section class="pedidos-por-cliente-section collapsible-section">
            <button class="section-toggle" onclick="toggleSection('pedidos-listo-section')" aria-expanded="false">
                <span class="toggle-icon">‚ñ∂</span>
                <h2>‚úÖ Pedido Listo <span id="contador-listo" class="contador-secuencia">(0)</span></h2>
            </button>
            
            <div id="pedidos-listo-section" class="collapsible-content" style="display: none;">
                <div id="pedidos-listo" class="pedidos-container">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </section>

        <!-- Nueva secci√≥n: Art√≠culos de Pedidos Confirmados -->
        <section class="pedidos-por-cliente-section collapsible-section">
            <!-- Bot√≥n de Toggle -->
            <button class="section-toggle" onclick="toggleSection('articulos-section')" aria-expanded="false">
                <span class="toggle-icon">‚ñ∂</span>
                <h2>Art√≠culos de Pedidos Confirmados</h2>
            </button>
            
            <!-- Contenido Colapsable -->
            <div id="articulos-section" class="collapsible-content" style="display: none;">
                <div class="pedidos-header">
                    <div class="pedidos-controls">
                        <label for="fecha-corte-articulos">Fecha limite:</label>
                        <input type="date" id="fecha-corte-articulos" name="fecha-corte-articulos" />
                        <input type="text" id="buscar-articulo" placeholder="Buscar art√≠culo..." />
                        <select id="filtro-estado-articulos">
                            <option value="todos">Todos los estados</option>
                            <option value="faltante">Solo faltantes</option>
                            <option value="parcial">Solo parciales</option>
                            <option value="completo">Solo completos</option>
                        </select>
                        <button id="refresh-articulos" class="admin-button">Actualizar</button>
                    </div>
                </div>
                
                <!-- Totales por estado -->
                <div id="totales-articulos" class="totales-estado" style="padding: 10px; margin-bottom: 10px; background-color: #e9ecef; border-radius: 4px; text-align: center; font-weight: bold;">
                    <!-- Los totales se cargar√°n din√°micamente -->
                </div>
                
                <div id="articulos-container" class="pedidos-container">
                    <!-- Aqu√≠ se renderizar√° la tabla de art√≠culos consolidados -->
                </div>
            </div>
        </section>

        <!-- Modal para asignar faltantes -->
        <div id="modal-asignar-faltantes" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Asignar Faltantes a Produccion</h3>
                    <button class="modal-close" aria-label="Cerrar modal" onclick="cerrarModalAsignar()">&times;</button>
                </div>
                <div class="modal-body">
                    <label for="usuario-asignar">Usuario:</label>
                    <select id="usuario-asignar" name="usuario-asignar">
                        <!-- Opciones cargadas din√°micamente -->
                    </select>
                    <div id="articulos-faltantes-lista" class="faltantes-lista">
                        <!-- Lista de art√≠culos faltantes para asignar -->
                    </div>
                    <div id="modal-mensaje" class="mensaje-info"></div>
                </div>
                <div class="modal-footer">
                    <button id="confirmar-asignacion" class="admin-button">Asignar a Produccion</button>
                </div>
            </div>
        </div>

        <!-- Modal para configurar pack -->
        <div id="modal-pack" class="modal-pack-overlay" style="display:none;">
            <div class="modal-pack-content">
                <div class="modal-pack-header">
                    <h3 id="modal-pack-titulo">Crear nuevo pack</h3>
                    <button class="modal-close" aria-label="Cerrar modal" onclick="cerrarModalPack()">&times;</button>
                </div>
                <div class="modal-pack-body">
                    <!-- Informaci√≥n del padre (sin input, solo display) -->
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #6f42c1;">
                        <div style="font-size: 18px; font-weight: 700; color: #333; margin-bottom: 5px;" id="pack-padre-descripcion">
                            Cargando...
                        </div>
                        <div style="font-size: 12px; color: #6c757d; font-weight: 500;">
                            Codigo: <span id="pack-padre-codigo-display" style="font-family: monospace;">-</span>
                        </div>
                    </div>
                    
                    <!-- Campo oculto para mantener el c√≥digo del padre -->
                    <input type="hidden" id="pack-padre-codigo">

                    <!-- B√∫squeda de art√≠culo hijo con autocompletado -->
                    <label for="pack-hijo-busqueda" style="font-weight: 600; margin-bottom: 8px; display: block;">
                        üîó Articulo Hijo:
                    </label>
                    <div style="position: relative; margin-bottom: 15px;">
                        <input 
                            type="text" 
                            id="pack-hijo-busqueda" 
                            placeholder="Buscar por codigo o descripcion..."
                            autocomplete="off"
                            style="width: 100%; padding: 10px; border: 2px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        
                        <!-- Lista desplegable de resultados -->
                        <div id="pack-hijo-resultados" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 2px solid #6f42c1; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1001;">
                            <!-- Resultados din√°micos -->
                        </div>
                    </div>
                    
                    <!-- Campo oculto para el c√≥digo del hijo seleccionado -->
                    <input type="hidden" id="pack-hijo-codigo">
                    
                    <!-- Mostrar hijo seleccionado -->
                    <div id="pack-hijo-seleccionado" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #d4edda; border-radius: 4px; border-left: 4px solid #28a745;">
                        <div style="font-weight: 600; color: #155724;" id="pack-hijo-seleccionado-texto"></div>
                    </div>

                    <label for="pack-unidades" style="font-weight: 600; margin-bottom: 8px; display: block;">
                        üî¢ Unidades por Pack:
                    </label>
                    <input 
                        type="number" 
                        id="pack-unidades" 
                        min="1" 
                        placeholder="Ej: 2"
                        style="width: 100%; padding: 10px; border: 2px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                    
                    <div id="pack-mensaje" class="mensaje-info" style="display:none; margin-top: 15px;"></div>
                </div>
                <div class="modal-pack-footer">
                    <button id="pack-guardar" class="pack-save-button" disabled>Guardar</button>
                    <button id="pack-quitar" class="pack-remove-button" style="display:none;">Quitar mapeo</button>
                    <button class="pack-cancel-button" onclick="cerrarModalPack()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal para Armar Pedido (Verificaci√≥n Interactiva) -->
        <div id="modal-armar-pedido" class="modal-overlay" style="display:none;">
            <div class="modal-content modal-armar-grande">
                <div class="modal-header">
                    <h3>üîç Verificar Pedido - <span id="modal-presupuesto-titulo"></span></h3>
                    <button class="modal-close" aria-label="Cerrar modal" onclick="cerrarModalArmarPedido()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <!-- Campo de escaneo -->
                    <div class="scanner-section">
                        <label for="scanner-input">Escanear C√≥digo de Barras:</label>
                        <input type="text" id="scanner-input" placeholder="Escanee o ingrese c√≥digo de art√≠culo..." autocomplete="off">
                        <div id="scanner-feedback" class="feedback-message"></div>
                    </div>
                    
                    <!-- Progreso -->
                    <div class="progress-section">
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                        </div>
                        <p id="progress-text" style="text-align: center; margin-top: 10px; font-weight: bold;">0 de 0 art√≠culos confirmados</p>
                    </div>
                    
                    <!-- Lista de art√≠culos -->
                    <div class="articulos-verificacion">
                        <table class="articulos-tabla tabla-verificacion">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Estado</th>
                                    <th>C√≥digo</th>
                                    <th>Descripci√≥n</th>
                                    <th style="width: 100px;">Pedida</th>
                                    <th style="width: 120px;">Confirmada</th>
                                    <th style="width: 100px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista-articulos-verificacion">
                                <!-- Filas din√°micas -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="btn-confirmar-pedido-completo" class="btn-confirmar-pedido" disabled>
                        ‚úÖ Confirmar Pedido Completo
                    </button>
                    <button class="admin-button" style="background: #6c757d;" onclick="cerrarModalArmarPedido()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </section>
</main>

        <footer>
            <p>&copy; 2024 Gestiones Lamda</p>
        </footer>
    </div>

    <script src="/js/produccion.js?v=8.0"></script>
    <script src="/js/produccion-resumen-expandible.js?v=17.0"></script>
    <script src="/js/modal-pack-mejorado.js?v=2.0"></script>
    
    <!-- Script para funcionalidad de secciones colapsables -->
    <script>
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const button = document.querySelector(`[onclick="toggleSection('${sectionId}')"]`);
            const icon = button.querySelector('.toggle-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                // Expandir secci√≥n
                content.style.display = 'block';
                content.classList.add('expanding');
                content.classList.remove('collapsing');
                button.setAttribute('aria-expanded', 'true');
                
                // Remover clase de animaci√≥n despu√©s de completarse
                setTimeout(() => {
                    content.classList.remove('expanding');
                }, 300);
                
            } else {
                // Colapsar secci√≥n
                content.classList.add('collapsing');
                content.classList.remove('expanding');
                button.setAttribute('aria-expanded', 'false');
                
                // Ocultar despu√©s de la animaci√≥n
                setTimeout(() => {
                    content.style.display = 'none';
                    content.classList.remove('collapsing');
                }, 300);
            }
        }

        // Funci√≥n para inicializar el estado de las secciones al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[INIT] PASO 1 - DOMContentLoaded disparado - Inicializando secciones colapsables');
            
            // Asegurar que todas las secciones est√©n colapsadas al inicio
            const collapsibleSections = document.querySelectorAll('.collapsible-content');
            const toggleButtons = document.querySelectorAll('.section-toggle');
            
            collapsibleSections.forEach(section => {
                section.style.display = 'none';
            });
            
            toggleButtons.forEach(button => {
                button.setAttribute('aria-expanded', 'false');
            });
            
            console.log('[INIT] PASO 1 COMPLETADO - Secciones colapsables inicializadas correctamente');
        });

        // Funci√≥n para expandir una secci√≥n espec√≠fica (√∫til para llamadas externas)
        function expandSection(sectionId) {
            const content = document.getElementById(sectionId);
            const button = document.querySelector(`[onclick="toggleSection('${sectionId}')"]`);
            
            if (content && content.style.display === 'none') {
                toggleSection(sectionId);
            }
        }

        // Funci√≥n para colapsar una secci√≥n espec√≠fica (√∫til para llamadas externas)
        function collapseSection(sectionId) {
            const content = document.getElementById(sectionId);
            const button = document.querySelector(`[onclick="toggleSection('${sectionId}')"]`);
            
            if (content && content.style.display !== 'none') {
                toggleSection(sectionId);
            }
        }

        // ===== FUNCIONALIDAD DEL RESUMEN DE FALTANTES Y PARCIALES =====
        
        // Variable global para compartir datos entre resumen y panel principal
        let datosArticulosCompartidos = null;
        let ultimaActualizacion = 0;

        // Funci√≥n para normalizar estados (corregir variantes tipogr√°ficas)
        function normalizarEstado(estado) {
            if (!estado) return '';
            
            return estado.toString()
                .trim()
                .toUpperCase()
                .replace(/FALLANTE/g, 'FALTANTE') // Corregir "FALLANTE" ‚Üí "FALTANTE"
                .replace(/[√Å√Ä√Ñ√Ç]/g, 'A')
                .replace(/[√â√à√ã√ä]/g, 'E')
                .replace(/[√ç√å√è√é]/g, 'I')
                .replace(/[√ì√í√ñ√î]/g, 'O')
                .replace(/[√ö√ô√ú√õ]/g, 'U');
        }

        // Funci√≥n para parsear n√∫mero de forma segura
        function parseNumeroSeguro(valor) {
            if (valor === null || valor === undefined || valor === '') return 0;
            const numero = Number(valor);
            return isNaN(numero) ? 0 : numero;
        }

        // Funci√≥n para extraer datos directamente del DOM del panel principal
        function obtenerDatosDesdeDOM() {
            console.log('[RESUMEN] obtenerDatosDesdeDOM() - Iniciando extracci√≥n');
            const articulos = [];
            
            try {
                // Buscar la tabla de art√≠culos en el panel principal
                const container = document.querySelector('#articulos-container');
                console.log('[RESUMEN] Container encontrado:', !!container);
                
                const tabla = document.querySelector('#articulos-container .articulos-tabla tbody');
                console.log('[RESUMEN] Tabla encontrada:', !!tabla);
                
                if (!tabla) {
                    console.log('[RESUMEN] ‚ö†Ô∏è No se encontr√≥ tabla de art√≠culos en el DOM - retornando array vac√≠o');
                    return [];
                }
                
                const filas = tabla.querySelectorAll('tr');
                console.debug('üîç Encontradas', filas.length, 'filas en la tabla');
                
                filas.forEach((fila, index) => {
                    const celdas = fila.querySelectorAll('td');
                    if (celdas.length >= 6) {
                        // Extraer datos de cada celda
                        const codigo = celdas[0]?.textContent?.trim() || '';
                        const descripcion = celdas[1]?.textContent?.trim() || '';
                        const pedidoTotal = parseNumeroSeguro(celdas[2]?.textContent?.trim());
                        const stockDisponible = parseNumeroSeguro(celdas[3]?.textContent?.trim());
                        const faltante = parseNumeroSeguro(celdas[4]?.textContent?.trim());
                        
                        // Extraer estado del badge/indicador
                        const estadoElement = celdas[5]?.querySelector('.indicador-estado');
                        const estado = estadoElement?.textContent?.trim() || '';
                        
                        // Log del primer elemento para debug
                        if (index === 0) {
                            console.debug('üîç Primer art√≠culo extra√≠do:', {
                                codigo, descripcion, pedidoTotal, stockDisponible, faltante, estado
                            });
                        }
                        
                        articulos.push({
                            codigo,
                            descripcion,
                            pedido_total: pedidoTotal,
                            stock_disponible: stockDisponible,
                            faltante,
                            estado: normalizarEstado(estado)
                        });
                    }
                });
                
                console.debug('üìä Art√≠culos extra√≠dos del DOM:', articulos.length);
                return articulos;
                
            } catch (error) {
                console.error('‚ùå Error al extraer datos del DOM:', error);
                return [];
            }
        }

        // Funci√≥n para obtener datos - USA EL MISMO ENDPOINT QUE EL PANEL PRINCIPAL
        async function obtenerDatosArticulosConFiltros() {
            console.log('[RESUMEN] obtenerDatosArticulosConFiltros() - Usando endpoint /pedidos-articulos');
            
            try {
                // Usar los mismos filtros que el panel principal
                const fechaCorte = document.getElementById('fecha-corte-articulos')?.value || '';
                
                let url = '/api/produccion/pedidos-articulos';
                const params = new URLSearchParams();
                
                if (fechaCorte) params.append('fecha', fechaCorte);
                // NO aplicar filtro de estado aqu√≠ - lo haremos despu√©s
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                console.log('[RESUMEN] Fetching desde:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('[RESUMEN] Respuesta del servidor:', result);
                
                // El endpoint retorna { success, data, total_articulos, totales }
                const articulos = result.data || [];
                console.log('[RESUMEN] Art√≠culos recibidos:', articulos.length);
                
                // Verificar que no hay promesas en las descripciones
                if (articulos.length > 0) {
                    const primerArticulo = articulos[0];
                    console.log('[RESUMEN] Primer art√≠culo:', {
                        articulo_numero: primerArticulo.articulo_numero,
                        descripcion: primerArticulo.descripcion,
                        tipoDescripcion: typeof primerArticulo.descripcion,
                        esPromise: primerArticulo.descripcion && typeof primerArticulo.descripcion.then === 'function'
                    });
                }
                
                datosArticulosCompartidos = articulos;
                ultimaActualizacion = Date.now();
                
                return articulos;
            } catch (error) {
                console.error('‚ùå [RESUMEN] Error al obtener datos:', error);
                return [];
            }
        }

        // Funci√≥n para filtrar faltantes y parciales - USA EL CAMPO estado DEL BACKEND
        function filtrarFaltantesYParciales(articulos) {
            console.log('[RESUMEN] filtrarFaltantesYParciales() - Filtrando', articulos.length, 'art√≠culos');
            
            if (!Array.isArray(articulos)) {
                console.log('[RESUMEN] ‚ö†Ô∏è Dataset no es array:', typeof articulos);
                return { faltantes: [], parciales: [] };
            }

            const faltantes = [];
            const parciales = [];
            
            // El backend ya clasifica los art√≠culos con el campo "estado"
            // Solo necesitamos filtrar por estado !== "COMPLETO"
            articulos.forEach((art, index) => {
                const estadoNormalizado = normalizarEstado(art.estado);
                
                // Log del primer elemento
                if (index === 0) {
                    console.log('[RESUMEN] Primer art√≠culo del backend:', {
                        articulo_numero: art.articulo_numero,
                        descripcion: art.descripcion,
                        estado: art.estado,
                        estadoNormalizado: estadoNormalizado,
                        tipoDescripcion: typeof art.descripcion
                    });
                }
                
                // Filtrar por estado (excluir COMPLETO)
                if (estadoNormalizado === 'FALTANTE') {
                    faltantes.push(art);
                } else if (estadoNormalizado === 'PARCIAL') {
                    parciales.push(art);
                }
                // Ignorar COMPLETO
            });

            console.log('[RESUMEN] Resultados del filtrado:', {
                total: articulos.length,
                faltantes: faltantes.length,
                parciales: parciales.length
            });

            return { faltantes, parciales };
        }

        // Funci√≥n para renderizar una fila de art√≠culo en el resumen
        // VERSI√ìN DIRECTA SIN DEPENDENCIA DEL M√ìDULO EXTERNO
        function renderizarFilaResumen(articulo, tipo) {
            console.log('[RENDER-FILA] Entrada:', { articulo, tipo });
            
            // Extraer valores directamente
            const codigoArticulo = articulo.articulo_numero || articulo.codigo || articulo.articulo || '-';
            const descripcion = articulo.descripcion || articulo.nombre || '-';
            const pedidoTotal = formatearNumeroResumen(articulo.pedido_total || articulo.cantidad_pedida || 0);
            const stockDisponible = formatearNumeroResumen(articulo.stock_disponible || articulo.stock || 0);
            const faltante = formatearNumeroResumen(articulo.faltante || articulo.cantidad_faltante || 0);
            
            console.log('[RENDER-FILA] Valores:', {
                codigoArticulo,
                descripcion,
                tipoDescripcion: typeof descripcion,
                pedidoTotal,
                stockDisponible,
                faltante
            });
            
            const estadoClass = tipo === 'FALTANTE' ? 'indicador-faltantes' : 'indicador-parcial';
            const rowClass = tipo === 'FALTANTE' ? 'faltante-row expandible-row parent-row' : 'parcial-row expandible-row parent-row';
            
            const html = `
                <tr class="${rowClass}" data-articulo="${codigoArticulo}">
                    <td class="col-articulo">${codigoArticulo}</td>
                    <td class="descripcion-col">${descripcion}</td>
                    <td>${pedidoTotal}</td>
                    <td>${stockDisponible}</td>
                    <td class="cantidad-faltante">${faltante}</td>
                    <td><span class="indicador-estado ${estadoClass}">${tipo}</span></td>
                    <td onclick="event.stopPropagation()">
                        <button class="pack-button pack-config-btn" data-codigo="${codigoArticulo}" onclick="abrirModalPack('${codigoArticulo}')">üß© Pack</button>
                    </td>
                </tr>
            `;
            
            console.log('[RENDER-FILA] HTML generado, tipo:', typeof html, 'longitud:', html.length);
            
            return html;
        }

        // Funci√≥n auxiliar para formatear n√∫meros a 2 decimales en el resumen
        function formatearNumeroResumen(valor) {
            if (valor === null || valor === undefined || valor === '') return '0.00';
            const numero = Number(valor);
            if (isNaN(numero)) return '0.00';
            return numero.toFixed(2);
        }

        // Funci√≥n para actualizar el resumen (sincronizada con panel principal)
        async function actualizarResumen() {
            console.log('[RESUMEN] actualizarResumen() - INICIO');
            const loadingEl = document.getElementById('summary-loading');
            const emptyEl = document.getElementById('summary-empty');
            const contentEl = document.getElementById('summary-content');
            const tbodyEl = document.getElementById('summary-tbody');

            // Mostrar loading
            loadingEl.style.display = 'block';
            emptyEl.style.display = 'none';
            contentEl.style.display = 'none';

            try {
                console.log('[RESUMEN] Llamando a obtenerDatosArticulosConFiltros()...');
                // Obtener datos con los mismos filtros que el panel principal
                const articulos = await obtenerDatosArticulosConFiltros();
                
                console.log('[RESUMEN] Datos recibidos de obtenerDatosArticulosConFiltros():', articulos);
                
                // ‚úÖ [RESUMEN] Diagn√≥stico: Verificar que articulos es un array v√°lido
                console.log('üìä [RESUMEN] Datos obtenidos:', {
                    esArray: Array.isArray(articulos),
                    cantidad: articulos?.length || 0,
                    primerElemento: articulos?.[0] ? {
                        codigo: articulos[0].codigo,
                        descripcion: articulos[0].descripcion,
                        tipoDescripcion: typeof articulos[0].descripcion,
                        esPromise: articulos[0].descripcion && typeof articulos[0].descripcion.then === 'function'
                    } : null
                });
                
                const { faltantes, parciales } = filtrarFaltantesYParciales(articulos);

                // Ocultar loading
                loadingEl.style.display = 'none';

                if (faltantes.length === 0 && parciales.length === 0) {
                    // Mostrar mensaje de sin faltantes ni parciales
                    emptyEl.style.display = 'block';
                    contentEl.style.display = 'none';
                    console.debug('‚úÖ [RESUMEN] Sin faltantes ni parciales encontrados');
                } else {
                    // Mostrar tabla con datos
                    emptyEl.style.display = 'none';
                    contentEl.style.display = 'block';

                    let html = '';
                    
                    // Agregar faltantes primero (orden solicitado)
                    if (faltantes.length > 0) {
                        faltantes.forEach((articulo, idx) => {
                            console.log(`[RESUMEN-RENDER] Renderizando faltante ${idx + 1}:`, {
                                articulo_numero: articulo.articulo_numero,
                                descripcion: articulo.descripcion,
                                tipoDescripcion: typeof articulo.descripcion,
                                esPromise: articulo.descripcion && typeof articulo.descripcion.then === 'function'
                            });
                            
                            const filaHtml = renderizarFilaResumen(articulo, 'FALTANTE');
                            console.log(`[RESUMEN-RENDER] HTML generado (primeros 200 chars):`, filaHtml.substring(0, 200));
                            html += filaHtml;
                        });
                    }

                    // Agregar separador visual si hay ambos tipos
                    if (faltantes.length > 0 && parciales.length > 0) {
                        html += '<tr class="summary-group-separator"><td colspan="7"></td></tr>';
                    }

                    // Agregar parciales despu√©s
                    if (parciales.length > 0) {
                        parciales.forEach((articulo, idx) => {
                            console.log(`[RESUMEN-RENDER] Renderizando parcial ${idx + 1}:`, {
                                articulo_numero: articulo.articulo_numero,
                                descripcion: articulo.descripcion,
                                tipoDescripcion: typeof articulo.descripcion,
                                esPromise: articulo.descripcion && typeof articulo.descripcion.then === 'function'
                            });
                            
                            const filaHtml = renderizarFilaResumen(articulo, 'PARCIAL');
                            console.log(`[RESUMEN-RENDER] HTML generado (primeros 200 chars):`, filaHtml.substring(0, 200));
                            html += filaHtml;
                        });
                    }

                    console.log('[RESUMEN-RENDER] HTML completo generado, longitud:', html.length);
                    tbodyEl.innerHTML = html;
                    console.log('‚úÖ [RESUMEN] Resumen renderizado:', faltantes.length, 'faltantes,', parciales.length, 'parciales');
                }

            } catch (error) {
                console.error('‚ùå [RESUMEN] Error al actualizar resumen:', error);
                loadingEl.style.display = 'none';
                emptyEl.innerHTML = '<span style="color: #dc3545;">‚ùå Error al cargar resumen</span>';
                emptyEl.style.display = 'block';
                contentEl.style.display = 'none';
            }
        }

        // Funci√≥n para observar cambios en la tabla del panel principal
        // DESHABILITADA - causaba bucles infinitos al detectar cambios en √≠conos
        function configurarObservadorTabla() {
            console.debug('‚ö†Ô∏è Observer de tabla DESHABILITADO para evitar bucles infinitos');
            return;
        }

        // Funci√≥n para sincronizar con todos los controles del panel principal
        function sincronizarConInformePrincipal() {
            // Sincronizar con cambios en fecha l√≠mite
            const fechaCorteArticulos = document.getElementById('fecha-corte-articulos');
            if (fechaCorteArticulos) {
                fechaCorteArticulos.addEventListener('change', () => {
                    console.debug('üîÑ Cambio en fecha l√≠mite, actualizando resumen...');
                    setTimeout(actualizarResumen, 500); // Delay para sincronizaci√≥n
                });
            }

            // Sincronizar con b√∫squeda de art√≠culos
            const buscarArticulo = document.getElementById('buscar-articulo');
            if (buscarArticulo) {
                buscarArticulo.addEventListener('input', () => {
                    console.debug('üîÑ Cambio en b√∫squeda, actualizando resumen...');
                    setTimeout(actualizarResumen, 800); // Delay para evitar muchas llamadas
                });
            }

            // Sincronizar con filtro de estado
            const filtroEstadoArticulos = document.getElementById('filtro-estado-articulos');
            if (filtroEstadoArticulos) {
                filtroEstadoArticulos.addEventListener('change', () => {
                    console.debug('üîÑ Cambio en filtro estado, actualizando resumen...');
                    setTimeout(actualizarResumen, 500);
                });
            }

            // Sincronizar con bot√≥n actualizar
            const refreshArticulos = document.getElementById('refresh-articulos');
            if (refreshArticulos) {
                refreshArticulos.addEventListener('click', () => {
                    console.debug('üîÑ Click en actualizar, sincronizando resumen...');
                    setTimeout(actualizarResumen, 1200); // Esperar que se actualice el panel principal
                });
            }

            // Observer deshabilitado - usar actualizar manual
            // configurarObservadorTabla();
        }

        // Inicializar el resumen cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[INIT] PASO 2 - Inicializando resumen de faltantes y parciales');
            
            try {
                console.log('[RESUMEN] Verificando elementos del DOM...');
                const loadingEl = document.getElementById('summary-loading');
                const emptyEl = document.getElementById('summary-empty');
                const contentEl = document.getElementById('summary-content');
                const tbodyEl = document.getElementById('summary-tbody');
                
                console.log('[RESUMEN] Elementos encontrados:', {
                    loading: !!loadingEl,
                    empty: !!emptyEl,
                    content: !!contentEl,
                    tbody: !!tbodyEl
                });
                
                // Inicializar despu√©s de que se carguen los controles del panel
                console.log('[RESUMEN] Programando actualizaci√≥n en 2 segundos...');
                setTimeout(() => {
                    console.log('[RESUMEN] Ejecutando actualizaci√≥n programada');
                    actualizarResumen();
                    sincronizarConInformePrincipal();
                    
                    // Actualizar √≠conos UNA SOLA VEZ despu√©s de la carga inicial
                    setTimeout(() => {
                        if (typeof window.actualizarIconosExpansion === 'function') {
                            console.log('[RESUMEN] Actualizando √≠conos de expansi√≥n');
                            window.actualizarIconosExpansion();
                        }
                    }, 3000);
                }, 2000);
                
                console.log('[INIT] PASO 2 COMPLETADO - Resumen programado');
            } catch (error) {
                console.error('[INIT] ERROR en PASO 2:', error);
            }
        });

        // Funci√≥n p√∫blica para actualizar el resumen (llamada externa)
        window.actualizarResumenFaltantes = function() {
            console.debug('üîÑ Actualizaci√≥n externa del resumen solicitada');
            actualizarResumen();
        };

        // ===== FUNCIONES GLOBALES PARA MODAL PACK =====
        // ‚ö†Ô∏è DESHABILITADAS - Ahora se usan las del archivo externo modal-pack-mejorado.js
        // Las funciones window.abrirModalPack y window.cerrarModalPack est√°n definidas en:
        // src/produccion/js/modal-pack-mejorado.js (cargado en l√≠nea 1323)
        
        console.log('[INIT] PASO 3 - Modal pack: usando versi√≥n externa (modal-pack-mejorado.js v2.0)');

    </script>
</body>
</html>

